# –†–æ–∑–¥—ñ–ª 46: –ú–∞–∫—Ä–æ—Å–∏ ‚Äî –ü—Ä–æ—Ü–µ–¥—É—Ä–Ω—ñ

---

## üìã –ê–Ω–æ—Ç–∞—Ü—ñ—è

–£ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–º—É —Ä–æ–∑–¥—ñ–ª—ñ –≤–∏ –æ–ø–∞–Ω—É–≤–∞–ª–∏ –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ñ –º–∞–∫—Ä–æ—Å–∏ (`macro_rules!`) ‚Äî –≤–æ–Ω–∏ –ø—Ä–∞—Ü—é—é—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤—ñ –ø–∞—Ç—Ç–µ—Ä–Ω-–º–∞—Ç—á–∏–Ω–≥—É —Ç–æ–∫–µ–Ω—ñ–≤. –ü–æ—Ç—É–∂–Ω–æ, –∞–ª–µ –æ–±–º–µ–∂–µ–Ω–æ: –≤–∏ –Ω–µ –º–æ–∂–µ—Ç–µ –∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∏–ø—É, –æ—Ç—Ä–∏–º–∞—Ç–∏ —Å–ø–∏—Å–æ–∫ –ø–æ–ª—ñ–≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏, —á–∏ –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∫–æ–¥ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ç–∏–ø—ñ–≤ –ø–æ–ª—ñ–≤.

**–ü—Ä–æ—Ü–µ–¥—É—Ä–Ω—ñ –º–∞–∫—Ä–æ—Å–∏** ‚Äî —Ü–µ –∑–æ–≤—Å—ñ–º —ñ–Ω—à–∏–π —Ä—ñ–≤–µ–Ω—å. –¶–µ —Å–ø—Ä–∞–≤–∂–Ω—ñ –ø—Ä–æ–≥—Ä–∞–º–∏ –Ω–∞ Rust, —â–æ –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è –ø—ñ–¥ —á–∞—Å –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó. –í–æ–Ω–∏ –æ—Ç—Ä–∏–º—É—é—Ç—å –≤—Ö—ñ–¥–Ω–∏–π –∫–æ–¥ —è–∫ –ø–æ—Ç—ñ–∫ —Ç–æ–∫–µ–Ω—ñ–≤, –º–æ–∂—É—Ç—å **–∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏** –π–æ–≥–æ (–ø–∞—Ä—Å–∏—Ç–∏ –≤ AST), **—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º—É–≤–∞—Ç–∏** –∑–∞ –¥–æ–≤—ñ–ª—å–Ω–æ—é –ª–æ–≥—ñ–∫–æ—é, —ñ –ø–æ–≤–µ—Ä—Ç–∞—Ç–∏ –Ω–æ–≤–∏–π –∫–æ–¥. –¶–µ –Ω–∞–π–ø–æ—Ç—É–∂–Ω—ñ—à–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –º–µ—Ç–∞–ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è –≤ Rust.

–í–∏, –Ω–∞–ø–µ–≤–Ω–æ, –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–ª–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω—ñ –º–∞–∫—Ä–æ—Å–∏, –Ω–∞–≤—ñ—Ç—å –Ω–µ –∑–∞–º–∏—Å–ª—é—é—á–∏—Å—å: `#[derive(Debug)]`, `#[derive(Clone)]`, `#[derive(Serialize)]` –≤—ñ–¥ Serde, `#[tokio::main]`. –í—Å—ñ –≤–æ–Ω–∏ ‚Äî –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω—ñ –º–∞–∫—Ä–æ—Å–∏, —â–æ –∞–Ω–∞–ª—ñ–∑—É—é—Ç—å –≤–∞—à –∫–æ–¥ —ñ –≥–µ–Ω–µ—Ä—É—é—Ç—å –¥–æ–¥–∞—Ç–∫–æ–≤—ñ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó.

–£ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ –º—É–ª—å—Ç–∏–∞–≥–µ–Ω—Ç–Ω–∏—Ö —Å–∏—Å—Ç–µ–º –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω—ñ –º–∞–∫—Ä–æ—Å–∏ –≤—ñ–¥–∫—Ä–∏–≤–∞—é—Ç—å –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ:
- `#[derive(Agent)]` ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –±–∞–∑–æ–≤–∏—Ö –º–µ—Ç–æ–¥—ñ–≤ –∞–≥–µ–Ω—Ç–∞
- `#[behavior]` ‚Äî —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—è —Ñ—É–Ω–∫—Ü—ñ—ó –≤ –æ–±—Ä–æ–±–Ω–∏–∫ –ø–æ–≤–µ–¥—ñ–Ω–∫–∏
- –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Å—Ç—Ä—É–∫—Ç—É—Ä –∞–≥–µ–Ω—Ç—ñ–≤ –ø—ñ–¥ —á–∞—Å –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó

---

## üéØ –¶—ñ–ª—ñ –Ω–∞–≤—á–∞–Ω–Ω—è

–ü—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ü—å–æ–≥–æ —Ä–æ–∑–¥—ñ–ª—É –≤–∏ –∑–º–æ–∂–µ—Ç–µ:

1. **–ü–æ—è—Å–Ω–∏—Ç–∏** —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—É —Ä—ñ–∑–Ω–∏—Ü—é –º—ñ–∂ –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–∏–º–∏ —Ç–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–∏–º–∏ –º–∞–∫—Ä–æ—Å–∞–º–∏
2. **–†–æ–∑—Ä—ñ–∑–Ω—è—Ç–∏** —Ç—Ä–∏ —Ç–∏–ø–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–∏—Ö –º–∞–∫—Ä–æ—Å—ñ–≤ (derive, attribute, function-like)
3. **–†–æ–∑—É–º—ñ—Ç–∏** –ø–æ—Ç—ñ–∫ –¥–∞–Ω–∏—Ö: TokenStream ‚Üí AST ‚Üí TokenStream
4. **–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏** –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ syn —Ç–∞ quote
5. **–ß–∏—Ç–∞—Ç–∏** –∫–æ–¥ —ñ—Å–Ω—É—é—á–∏—Ö derive –º–∞–∫—Ä–æ—Å—ñ–≤
6. **–°—Ç–≤–æ—Ä—é–≤–∞—Ç–∏** –ø—Ä–æ—Å—Ç—ñ derive —Ç–∞ attribute –º–∞–∫—Ä–æ—Å–∏

---

## üìö –ö–ª—é—á–æ–≤—ñ —Ç–µ—Ä–º—ñ–Ω–∏

| –¢–µ—Ä–º—ñ–Ω | –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è |
|--------|------------|
| **–ü—Ä–æ—Ü–µ–¥—É—Ä–Ω–∏–π –º–∞–∫—Ä–æ—Å** | –§—É–Ω–∫—Ü—ñ—è Rust, —â–æ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º—É—î TokenStream –ø—ñ–¥ —á–∞—Å –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó |
| **TokenStream** | –ü–æ—Ç—ñ–∫ —Ç–æ–∫–µ–Ω—ñ–≤ ‚Äî –Ω–∏–∑—å–∫–æ—Ä—ñ–≤–Ω–µ–≤–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è –≤–∏—Ö—ñ–¥–Ω–æ–≥–æ –∫–æ–¥—É |
| **AST** | Abstract Syntax Tree ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è –∫–æ–¥—É |
| **Derive –º–∞–∫—Ä–æ—Å** | –ú–∞–∫—Ä–æ—Å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—ó —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó trait —á–µ—Ä–µ–∑ #[derive(...)] |
| **Attribute –º–∞–∫—Ä–æ—Å** | –ú–∞–∫—Ä–æ—Å-–∞—Ç—Ä–∏–±—É—Ç #[my_attr], —â–æ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º—É—î item |
| **Function-like –º–∞–∫—Ä–æ—Å** | –ü—Ä–æ—Ü–µ–¥—É—Ä–Ω–∏–π –º–∞–∫—Ä–æ—Å, —â–æ –≤–∏–≥–ª—è–¥–∞—î —è–∫ –≤–∏–∫–ª–∏–∫ my_macro!(...) |
| **syn** | –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥—É TokenStream –≤ —Ç–∏–ø—ñ–∑–æ–≤–∞–Ω–∏–π AST |
| **quote** | –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó TokenStream –∑ —à–∞–±–ª–æ–Ω—ñ–≤ –∫–æ–¥—É |

---

## üí° –ú–æ—Ç–∏–≤–∞—Ü—ñ–π–Ω–∏–π –∫–µ–π—Å: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è

–£—è–≤—ñ–º–æ: —É –≤–∞—à—ñ–π —Å–∏—Å—Ç–µ–º—ñ 50 —Ä—ñ–∑–Ω–∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä, —ñ –∫–æ–∂–Ω–∞ –ø–æ—Ç—Ä–µ–±—É—î —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó trait `Serialize`. –í—Ä—É—á–Ω—É —Ü–µ –≤–∏–≥–ª—è–¥–∞—î —Ç–∞–∫:

```rust
impl Serialize for Agent {
    fn serialize(&self) -> String {
        format!("{{\"id\":{},\"position\":{{\"x\":{},\"y\":{}}},\"battery\":{}}}",
                self.id, self.position.x, self.position.y, self.battery)
    }
}

impl Serialize for Position {
    fn serialize(&self) -> String {
        format!("{{\"x\":{},\"y\":{}}}", self.x, self.y)
    }
}

impl Serialize for Command {
    fn serialize(&self) -> String {
        // ... —â–µ 20 —Ä—è–¥–∫—ñ–≤
    }
}

// –Ü —Ç–∞–∫ –¥–ª—è –∫–æ–∂–Ω–æ—ó –∑ 50 —Å—Ç—Ä—É–∫—Ç—É—Ä...
```

–¶–µ –Ω–µ –ø—Ä–æ—Å—Ç–æ –Ω—É–¥–Ω–æ ‚Äî —Ü–µ **–Ω–µ–±–µ–∑–ø–µ—á–Ω–æ**. –õ–µ–≥–∫–æ –ø–æ–º–∏–ª–∏—Ç–∏—Å—å, –∑–∞–±—É—Ç–∏ –ø–æ–ª–µ, –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç–∏ —Ñ–æ—Ä–º–∞—Ç. –Ü –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤—Ä—É—á–Ω—É –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—é.

–¢–µ–ø–µ—Ä –ø–æ–¥–∏–≤—ñ—Ç—å—Å—è –Ω–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É:

```rust
#[derive(Serialize)]
struct Agent {
    id: u32,
    position: Position,
    battery: u8,
}

#[derive(Serialize)]
struct Position {
    x: f64,
    y: f64,
}

#[derive(Serialize)]
struct Command {
    // ...
}
```

**–û–¥–Ω–∞ –∞–Ω–æ—Ç–∞—Ü—ñ—è** ‚Äî —ñ –∫–æ–¥ –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ. –î–æ–¥–∞–ª–∏ –Ω–æ–≤–µ –ø–æ–ª–µ? –°–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è. –ü–æ–º–∏–ª–∫–∞ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è? –ù–µ–º–æ–∂–ª–∏–≤–∞ ‚Äî –º–∞–∫—Ä–æ—Å –≥–µ–Ω–µ—Ä—É—î –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –∫–æ–¥.

–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ **Serde** —Ä–æ–±–∏—Ç—å —Å–∞–º–µ —Ü–µ —á–µ—Ä–µ–∑ –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω—ñ –º–∞–∫—Ä–æ—Å–∏. –Ü –≤–∏ –º–æ–∂–µ—Ç–µ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –≤–ª–∞—Å–Ω—ñ –ø–æ–¥—ñ–±–Ω—ñ –º–∞–∫—Ä–æ—Å–∏.

---

## 46.1 –î–ï–ö–õ–ê–†–ê–¢–ò–í–ù–Ü VS –ü–†–û–¶–ï–î–£–†–ù–Ü: –§–£–ù–î–ê–ú–ï–ù–¢–ê–õ–¨–ù–ê –†–Ü–ó–ù–ò–¶–Ø

### 46.1.1 –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–æ—Ç–æ–∫—É –¥–∞–Ω–∏—Ö

–†–æ–∑–≥–ª—è–Ω–µ–º–æ, —è–∫ –ø—Ä–∞—Ü—é—é—Ç—å –æ–±–∏–¥–≤–∞ —Ç–∏–ø–∏ –º–∞–∫—Ä–æ—Å—ñ–≤:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ               –î–ï–ö–õ–ê–†–ê–¢–ò–í–ù–Ü –ú–ê–ö–†–û–°–ò (macro_rules!)                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                     ‚îÇ
‚îÇ  –í—Ö—ñ–¥: –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å —Ç–æ–∫–µ–Ω—ñ–≤                                       ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                    ‚îÇ
‚îÇ  my_macro!(a, b, c)                                                ‚îÇ
‚îÇ           ‚îÇ                                                         ‚îÇ
‚îÇ           ‚ñº                                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                               ‚îÇ
‚îÇ  ‚îÇ    –ü–ê–¢–¢–ï–†–ù-–ú–ê–¢–ß–ò–ù–ì              ‚îÇ                               ‚îÇ
‚îÇ  ‚îÇ                                 ‚îÇ                               ‚îÇ
‚îÇ  ‚îÇ  ($($x:expr),*) => { ... }      ‚îÇ                               ‚îÇ
‚îÇ  ‚îÇ        ‚Üì                        ‚îÇ                               ‚îÇ
‚îÇ  ‚îÇ  –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î? –¢–∞–∫ ‚Üí –ø—ñ–¥—Å—Ç–∞–≤–∏—Ç–∏   ‚îÇ                               ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                               ‚îÇ
‚îÇ           ‚îÇ                                                         ‚îÇ
‚îÇ           ‚ñº                                                         ‚îÇ
‚îÇ  –í–∏—Ö—ñ–¥: —Ä–æ–∑–≥–æ—Ä–Ω—É—Ç–∏–π –∫–æ–¥                                            ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                             ‚îÇ
‚îÇ  { /* –ø—ñ–¥—Å—Ç–∞–≤–ª–µ–Ω—ñ a, b, c */ }                                     ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ  ‚ö†Ô∏è –û–±–º–µ–∂–µ–Ω–Ω—è:                                                      ‚îÇ
‚îÇ  ‚Ä¢ –ù–µ –±–∞—á–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∏–ø—ñ–≤                                       ‚îÇ
‚îÇ  ‚Ä¢ –ù–µ –º–æ–∂–µ –∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –ø–æ–ª—è struct                                 ‚îÇ
‚îÇ  ‚Ä¢ –¢—ñ–ª—å–∫–∏ –ø—ñ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–º                                 ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ               –ü–†–û–¶–ï–î–£–†–ù–Ü –ú–ê–ö–†–û–°–ò                                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                     ‚îÇ
‚îÇ  –í—Ö—ñ–¥: TokenStream (–ø–æ—Ç—ñ–∫ —Ç–æ–∫–µ–Ω—ñ–≤)                                 ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                  ‚îÇ
‚îÇ  #[derive(MyTrait)]                                                ‚îÇ
‚îÇ  struct Agent { id: u32, ... }                                     ‚îÇ
‚îÇ           ‚îÇ                                                         ‚îÇ
‚îÇ           ‚ñº                                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                               ‚îÇ
‚îÇ  ‚îÇ    –ü–ê–†–°–ò–ù–ì (syn)                ‚îÇ                               ‚îÇ
‚îÇ  ‚îÇ                                 ‚îÇ                               ‚îÇ
‚îÇ  ‚îÇ  TokenStream ‚Üí DeriveInput      ‚îÇ                               ‚îÇ
‚îÇ  ‚îÇ       ‚Ä¢ name: "Agent"           ‚îÇ                               ‚îÇ
‚îÇ  ‚îÇ       ‚Ä¢ fields: [id, ...]       ‚îÇ                               ‚îÇ
‚îÇ  ‚îÇ       ‚Ä¢ types: [u32, ...]       ‚îÇ                               ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                               ‚îÇ
‚îÇ           ‚îÇ                                                         ‚îÇ
‚îÇ           ‚ñº                                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                               ‚îÇ
‚îÇ  ‚îÇ    –ê–ù–ê–õ–Ü–ó + –¢–†–ê–ù–°–§–û–†–ú–ê–¶–Ü–Ø       ‚îÇ                               ‚îÇ
‚îÇ  ‚îÇ    (–∑–≤–∏—á–∞–π–Ω–∏–π Rust –∫–æ–¥)         ‚îÇ                               ‚îÇ
‚îÇ  ‚îÇ                                 ‚îÇ                               ‚îÇ
‚îÇ  ‚îÇ  for field in fields {          ‚îÇ                               ‚îÇ
‚îÇ  ‚îÇ      // –±—É–¥—å-—è–∫–∞ –ª–æ–≥—ñ–∫–∞         ‚îÇ                               ‚îÇ
‚îÇ  ‚îÇ  }                              ‚îÇ                               ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                               ‚îÇ
‚îÇ           ‚îÇ                                                         ‚îÇ
‚îÇ           ‚ñº                                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                               ‚îÇ
‚îÇ  ‚îÇ    –ì–ï–ù–ï–†–ê–¶–Ü–Ø –ö–û–î–£ (quote)       ‚îÇ                               ‚îÇ
‚îÇ  ‚îÇ                                 ‚îÇ                               ‚îÇ
‚îÇ  ‚îÇ  quote! {                       ‚îÇ                               ‚îÇ
‚îÇ  ‚îÇ      impl MyTrait for #name {   ‚îÇ                               ‚îÇ
‚îÇ  ‚îÇ          ...                    ‚îÇ                               ‚îÇ
‚îÇ  ‚îÇ      }                          ‚îÇ                               ‚îÇ
‚îÇ  ‚îÇ  }                              ‚îÇ                               ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                               ‚îÇ
‚îÇ           ‚îÇ                                                         ‚îÇ
‚îÇ           ‚ñº                                                         ‚îÇ
‚îÇ  –í–∏—Ö—ñ–¥: TokenStream (–∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π –∫–æ–¥)                             ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                             ‚îÇ
‚îÇ  impl MyTrait for Agent { ... }                                    ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ  ‚úÖ –ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ:                                                     ‚îÇ
‚îÇ  ‚Ä¢ –ü–æ–≤–Ω–∏–π –¥–æ—Å—Ç—É–ø –¥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ —Ç–∏–ø—É                                 ‚îÇ
‚îÇ  ‚Ä¢ –ê–Ω–∞–ª—ñ–∑ –ø–æ–ª—ñ–≤, —Ç–∏–ø—ñ–≤, –∞—Ç—Ä–∏–±—É—Ç—ñ–≤                                  ‚îÇ
‚îÇ  ‚Ä¢ –î–æ–≤—ñ–ª—å–Ω–∞ –ª–æ–≥—ñ–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó                                       ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 46.1.2 –ü–æ—Ä—ñ–≤–Ω—è–ª—å–Ω–∞ —Ç–∞–±–ª–∏—Ü—è

| –ê—Å–ø–µ–∫—Ç | –î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ñ | –ü—Ä–æ—Ü–µ–¥—É—Ä–Ω—ñ |
|--------|--------------|------------|
| **–°–∏–Ω—Ç–∞–∫—Å–∏—Å –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è** | `macro_rules! name { }` | `#[proc_macro_derive]` + —Ñ—É–Ω–∫—Ü—ñ—è |
| **–†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è** | –ü–∞—Ç—Ç–µ—Ä–Ω–∏ —Ç–∞ –ø—ñ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ | –ó–≤–∏—á–∞–π–Ω–∏–π Rust –∫–æ–¥ |
| **–ê–Ω–∞–ª—ñ–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ —Ç–∏–ø—ñ–≤** | ‚ùå –ù–µ–º–æ–∂–ª–∏–≤–æ | ‚úÖ –ü–æ–≤–Ω–∏–π –¥–æ—Å—Ç—É–ø |
| **–î–æ—Å—Ç—É–ø –¥–æ –ø–æ–ª—ñ–≤ struct** | ‚ùå –ù–µ–º–æ–∂–ª–∏–≤–æ | ‚úÖ –¢–∞–∫ |
| **Derive –¥–ª—è trait** | ‚ùå –ù–µ–º–æ–∂–ª–∏–≤–æ | ‚úÖ –û—Å–Ω–æ–≤–Ω–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è |
| **–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—è —Ñ—É–Ω–∫—Ü—ñ–π** | ‚ùå –î—É–∂–µ –æ–±–º–µ–∂–µ–Ω–æ | ‚úÖ –ü–æ–≤–Ω–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—è |
| **–û–∫—Ä–µ–º–∏–π –∫—Ä–µ–π—Ç** | –ù—ñ | –¢–∞–∫ (–æ–±–æ–≤'—è–∑–∫–æ–≤–æ) |
| **–ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ** | –ù–µ–º–∞—î | syn, quote |
| **–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å** | –ù–∏–∑—å–∫–∞-—Å–µ—Ä–µ–¥–Ω—è | –í–∏—Å–æ–∫–∞ |
| **–ß–∞—Å –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó** | –®–≤–∏–¥–∫–æ | –ü–æ–≤—ñ–ª—å–Ω—ñ—à–µ |
| **–î–µ–±–∞–≥** | –°–∫–ª–∞–¥–Ω–∏–π | `cargo expand` |

### 46.1.3 –ü—Ä–∞–≤–∏–ª–æ –≤–∏–±–æ—Ä—É

**–û–±–∏—Ä–∞–π—Ç–µ –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ñ –º–∞–∫—Ä–æ—Å–∏ (`macro_rules!`)**, –∫–æ–ª–∏:
- –ü–æ—Ç—Ä—ñ–±–Ω–∞ –ø—Ä–æ—Å—Ç–∞ –ø—ñ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—Å—Ç—É
- –ó–º—ñ–Ω–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –æ–¥–Ω–æ—Ç–∏–ø–Ω–∏—Ö –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤
- DSL –±–µ–∑ –∞–Ω–∞–ª—ñ–∑—É —Ç–∏–ø—ñ–≤
- –í–∞–∂–ª–∏–≤–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó

**–û–±–∏—Ä–∞–π—Ç–µ –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω—ñ –º–∞–∫—Ä–æ—Å–∏**, –∫–æ–ª–∏:
- –ü–æ—Ç—Ä—ñ–±–µ–Ω `#[derive(Trait)]`
- –ù–µ–æ–±—Ö—ñ–¥–Ω–æ –∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –ø–æ–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏
- –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∫–æ–¥—É –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ —Ç–∏–ø—ñ–≤
- –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—è —Ñ—É–Ω–∫—Ü—ñ–π (#[async], #[test])
- –í–∞–ª—ñ–¥–∞—Ü—ñ—è –ø—ñ–¥ —á–∞—Å –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó

---

## 46.2 –¢–†–ò –¢–ò–ü–ò –ü–†–û–¶–ï–î–£–†–ù–ò–• –ú–ê–ö–†–û–°–Ü–í

### 46.2.1 –û–≥–ª—è–¥ —Ç–∏–ø—ñ–≤

Rust –ø—ñ–¥—Ç—Ä–∏–º—É—î —Ç—Ä–∏ –≤–∏–¥–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–∏—Ö –º–∞–∫—Ä–æ—Å—ñ–≤, –∫–æ–∂–µ–Ω –¥–ª—è —Å–≤–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä—ñ—é:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                –¢–†–ò –¢–ò–ü–ò –ü–†–û–¶–ï–î–£–†–ù–ò–• –ú–ê–ö–†–û–°–Ü–í                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                     ‚îÇ
‚îÇ  1. DERIVE –ú–ê–ö–†–û–°–ò                                                  ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                                  ‚îÇ
‚îÇ  #[derive(MyTrait)]    ‚îÄ‚îÄ‚ñ∫    impl MyTrait for Foo { ... }         ‚îÇ
‚îÇ  struct Foo { ... }                                                ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ  ‚Ä¢ –î–æ–¥–∞—é—Ç—å —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó trait                                        ‚îÇ
‚îÇ  ‚Ä¢ –ù–µ –∑–º—ñ–Ω—é—é—Ç—å –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É                               ‚îÇ
‚îÇ  ‚Ä¢ –ù–∞–π–ø–æ—à–∏—Ä–µ–Ω—ñ—à–∏–π —Ç–∏–ø                                              ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                     ‚îÇ
‚îÇ  2. ATTRIBUTE –ú–ê–ö–†–û–°–ò                                               ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                               ‚îÇ
‚îÇ  #[my_attribute]       ‚îÄ‚îÄ‚ñ∫    fn foo_transformed() { ... }         ‚îÇ
‚îÇ  fn foo() { ... }                                                  ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ  ‚Ä¢ –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º—É—é—Ç—å –∞–±–æ –∑–∞–º—ñ–Ω—é—é—Ç—å item                                ‚îÇ
‚îÇ  ‚Ä¢ –î–ª—è —Ñ—É–Ω–∫—Ü—ñ–π, —Å—Ç—Ä—É–∫—Ç—É—Ä, –º–æ–¥—É–ª—ñ–≤                                  ‚îÇ
‚îÇ  ‚Ä¢ –ü—Ä–∏–∫–ª–∞–¥: #[tokio::main], #[test]                                ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                     ‚îÇ
‚îÇ  3. FUNCTION-LIKE –ú–ê–ö–†–û–°–ò                                           ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                           ‚îÇ
‚îÇ  my_macro!(...)        ‚îÄ‚îÄ‚ñ∫    /* –¥–æ–≤—ñ–ª—å–Ω–∏–π –∫–æ–¥ */                  ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ  ‚Ä¢ –í–∏–≥–ª—è–¥–∞—é—Ç—å —è–∫ –≤–∏–∫–ª–∏–∫ —Ñ—É–Ω–∫—Ü—ñ—ó                                    ‚îÇ
‚îÇ  ‚Ä¢ –î–ª—è —Å–∫–ª–∞–¥–Ω–∏—Ö DSL                                                ‚îÇ
‚îÇ  ‚Ä¢ –ü—Ä–∏–∫–ª–∞–¥: sql!("SELECT * FROM users")                            ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 46.2.2 Derive –º–∞–∫—Ä–æ—Å–∏: –¥–µ—Ç–∞–ª—å–Ω—ñ—à–µ

Derive –º–∞–∫—Ä–æ—Å–∏ ‚Äî –Ω–∞–π–ø–æ—à–∏—Ä–µ–Ω—ñ—à–∏–π —Ç–∏–ø. –í–æ–Ω–∏ **–¥–æ–¥–∞—é—Ç—å** –∫–æ–¥ –¥–æ —ñ—Å–Ω—É—é—á–æ–≥–æ —Ç–∏–ø—É, –Ω–µ –∑–º—ñ–Ω—é—é—á–∏ –π–æ–≥–æ.

```rust
// –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è derive –º–∞–∫—Ä–æ—Å–∞
#[proc_macro_derive(MyTrait)]
pub fn my_trait_derive(input: TokenStream) -> TokenStream {
    // input ‚Äî –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏/enum
    // output ‚Äî —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è trait (–¥–æ–¥–∞—î—Ç—å—Å—è –¥–æ –∫–æ–¥—É)
}

// –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
#[derive(MyTrait)]
struct Agent {
    id: u32,
    name: String,
}

// –†–µ–∑—É–ª—å—Ç–∞—Ç: –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è,
// –¥–æ–¥–∞—î—Ç—å—Å—è impl MyTrait for Agent { ... }
```

**–ü—Ä–∏–∫–ª–∞–¥–∏ –∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ—ó –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ —Ç–∞ –µ–∫–æ—Å–∏—Å—Ç–µ–º–∏:**
- `#[derive(Debug)]` ‚Äî –≥–µ–Ω–µ—Ä—É—î —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è
- `#[derive(Clone)]` ‚Äî –≥–µ–Ω–µ—Ä—É—î –º–µ—Ç–æ–¥ clone()
- `#[derive(PartialEq)]` ‚Äî –≥–µ–Ω–µ—Ä—É—î –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è ==
- `#[derive(Serialize, Deserialize)]` ‚Äî Serde —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è

### 46.2.3 Attribute –º–∞–∫—Ä–æ—Å–∏: –¥–µ—Ç–∞–ª—å–Ω—ñ—à–µ

Attribute –º–∞–∫—Ä–æ—Å–∏ **—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º—É—é—Ç—å** item ‚Äî —Ñ—É–Ω–∫—Ü—ñ—é, —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –º–æ–¥—É–ª—å. –ù–∞ –≤—ñ–¥–º—ñ–Ω—É –≤—ñ–¥ derive, –≤–æ–Ω–∏ **–∑–∞–º—ñ–Ω—é—é—Ç—å** –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –∫–æ–¥.

```rust
// –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è attribute –º–∞–∫—Ä–æ—Å–∞
#[proc_macro_attribute]
pub fn my_attribute(attr: TokenStream, item: TokenStream) -> TokenStream {
    // attr ‚Äî –∞—Ä–≥—É–º–µ–Ω—Ç–∏ –∞—Ç—Ä–∏–±—É—Ç–∞ (—Ç–µ, —â–æ –≤ –¥—É–∂–∫–∞—Ö)
    // item ‚Äî —Å–∞–º item (—Ñ—É–Ω–∫—Ü—ñ—è, struct, —Ç–æ—â–æ)
    // output ‚Äî –ó–ê–ú–Ü–ù–Æ–Ñ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π item
}

// –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
#[my_attribute(some_arg)]
fn original_function() {
    println!("Hello");
}

// –†–µ–∑—É–ª—å—Ç–∞—Ç: original_function –∑–∞–º—ñ–Ω–µ–Ω–∞ –Ω–∞ —Ç–µ,
// —â–æ –ø–æ–≤–µ—Ä–Ω–µ –º–∞–∫—Ä–æ—Å
```

**–ü—Ä–∏–∫–ª–∞–¥–∏ –∑ –µ–∫–æ—Å–∏—Å—Ç–µ–º–∏:**
- `#[tokio::main]` ‚Äî –æ–±–≥–æ—Ä—Ç–∞—î main –≤ async runtime
- `#[test]` ‚Äî –ø–æ–∑–Ω–∞—á–∞—î —Ñ—É–Ω–∫—Ü—ñ—é —è–∫ —Ç–µ—Å—Ç
- `#[instrument]` ‚Äî –¥–æ–¥–∞—î tracing –¥–æ —Ñ—É–Ω–∫—Ü—ñ—ó

### 46.2.4 Function-like –º–∞–∫—Ä–æ—Å–∏: –¥–µ—Ç–∞–ª—å–Ω—ñ—à–µ

Function-like –º–∞–∫—Ä–æ—Å–∏ –≤–∏–≥–ª—è–¥–∞—é—Ç—å —è–∫ –≤–∏–∫–ª–∏–∫–∏ —Ñ—É–Ω–∫—Ü—ñ–π, –∞–ª–µ –æ–±—Ä–æ–±–ª—è—é—Ç—å—Å—è –ø—ñ–¥ —á–∞—Å –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó.

```rust
// –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è
#[proc_macro]
pub fn my_dsl(input: TokenStream) -> TokenStream {
    // input ‚Äî –≤—Å–µ, —â–æ –ø–µ—Ä–µ–¥–∞–Ω–æ –≤ –¥—É–∂–∫–∞—Ö
    // output ‚Äî –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π –∫–æ–¥
}

// –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
let query = sql!("SELECT * FROM agents WHERE battery > 50");
```

**–ü—Ä–∏–∫–ª–∞–¥–∏:**
- `sql!()` ‚Äî SQL –∑–∞–ø–∏—Ç–∏ –∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é –ø—ñ–¥ —á–∞—Å –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó
- `html!()` ‚Äî HTML —à–∞–±–ª–æ–Ω–∏
- `json!()` ‚Äî JSON –∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é —Å–∏–Ω—Ç–∞–∫—Å–∏—Å—É

---

## 46.3 –ê–†–•–Ü–¢–ï–ö–¢–£–†–ê –ü–†–û–¶–ï–î–£–†–ù–û–ì–û –ú–ê–ö–†–û–°–ê

### 46.3.1 –ß–æ–º—É –æ–∫—Ä–µ–º–∏–π –∫—Ä–µ–π—Ç?

–ü—Ä–æ—Ü–µ–¥—É—Ä–Ω—ñ –º–∞–∫—Ä–æ—Å–∏ **–æ–±–æ–≤'—è–∑–∫–æ–≤–æ** –º–∞—é—Ç—å –±—É—Ç–∏ –≤ –æ–∫—Ä–µ–º–æ–º—É –∫—Ä–µ–π—Ç—ñ –∑ `proc-macro = true`. –ß–æ–º—É?

**–ü—Ä–∏—á–∏–Ω–∞ 1: –ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è**

–ú–∞–∫—Ä–æ—Å –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –ø—ñ–¥ —á–∞—Å –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó **–≤–∞—à–æ–≥–æ** –∫—Ä–µ–π—Ç–∞. –¢–æ–º—É –∫–æ–¥ –º–∞–∫—Ä–æ—Å–∞ –º–∞—î –±—É—Ç–∏ –≤–∂–µ —Å–∫–æ–º–ø—ñ–ª—å–æ–≤–∞–Ω–∏–π. –Ø–∫–±–∏ –≤—ñ–Ω –±—É–≤ —É —Ç–æ–º—É –∂ –∫—Ä–µ–π—Ç—ñ ‚Äî –≤–∏–Ω–∏–∫–ª–∞ –± —Ü–∏–∫–ª—ñ—á–Ω–∞ –∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å.

**–ü—Ä–∏—á–∏–Ω–∞ 2: –Ü–∑–æ–ª—è—Ü—ñ—è**

–ú–∞–∫—Ä–æ—Å –º–∞—î –¥–æ—Å—Ç—É–ø –¥–æ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ–≥–æ API (`proc_macro` crate), –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –¥–ª—è –∑–≤–∏—á–∞–π–Ω–æ–≥–æ –∫–æ–¥—É. –û–∫—Ä–µ–º–∏–π –∫—Ä–µ–π—Ç –∑–∞–±–µ–∑–ø–µ—á—É—î —á—ñ—Ç–∫—É –º–µ–∂—É.

### 46.3.2 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫—Ä–µ–π—Ç–∞ –º–∞–∫—Ä–æ—Å–∞

```
my_derive_macro/
‚îú‚îÄ‚îÄ Cargo.toml
‚îî‚îÄ‚îÄ src/
    ‚îî‚îÄ‚îÄ lib.rs

# Cargo.toml
[package]
name = "my_derive_macro"
version = "0.1.0"
edition = "2021"

[lib]
proc-macro = true    # ‚Üê –û–±–æ–≤'—è–∑–∫–æ–≤–æ!

[dependencies]
syn = { version = "2", features = ["full"] }
quote = "1"
proc-macro2 = "1"
```

**–ö–ª—é—á–æ–≤–∏–π —Ä—è–¥–æ–∫:** `proc-macro = true` –≤–∫–∞–∑—É—î Cargo, —â–æ —Ü–µ –∫—Ä–µ–π—Ç –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–æ–≥–æ –º–∞–∫—Ä–æ—Å–∞.

### 46.3.3 –ü–æ–≤–Ω–∏–π –ø–æ—Ç—ñ–∫ –¥–∞–Ω–∏—Ö

–†–æ–∑–≥–ª—è–Ω–µ–º–æ, —â–æ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –ø—Ä–∏ –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó –∫–æ–¥—É –∑ derive –º–∞–∫—Ä–æ—Å–æ–º:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    –ü–û–¢–Ü–ö –ö–û–ú–ü–Ü–õ–Ø–¶–Ü–á                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                     ‚îÇ
‚îÇ  1. –í–ò–•–Ü–î–ù–ò–ô –ö–û–î                                                    ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                                   ‚îÇ
‚îÇ  #[derive(MyTrait)]                                                ‚îÇ
‚îÇ  struct Agent {                                                    ‚îÇ
‚îÇ      id: u32,                                                      ‚îÇ
‚îÇ      name: String,                                                 ‚îÇ
‚îÇ  }                                                                 ‚îÇ
‚îÇ           ‚îÇ                                                         ‚îÇ
‚îÇ           ‚ñº                                                         ‚îÇ
‚îÇ  2. –¢–û–ö–ï–ù–Ü–ó–ê–¶–Ü–Ø (Rust compiler)                                    ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                    ‚îÇ
‚îÇ  TokenStream: [                                                    ‚îÇ
‚îÇ      Ident("struct"), Ident("Agent"), Punct('{'),                 ‚îÇ
‚îÇ      Ident("id"), Punct(':'), Ident("u32"), Punct(','),           ‚îÇ
‚îÇ      Ident("name"), Punct(':'), Ident("String"), Punct(','),      ‚îÇ
‚îÇ      Punct('}')                                                    ‚îÇ
‚îÇ  ]                                                                 ‚îÇ
‚îÇ           ‚îÇ                                                         ‚îÇ
‚îÇ           ‚ñº                                                         ‚îÇ
‚îÇ  3. –í–ò–ö–õ–ò–ö –ú–ê–ö–†–û–°–ê                                                 ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                                ‚îÇ
‚îÇ  my_trait_derive(token_stream) –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è                        ‚îÇ
‚îÇ           ‚îÇ                                                         ‚îÇ
‚îÇ           ‚ñº                                                         ‚îÇ
‚îÇ  4. –ü–ê–†–°–ò–ù–ì (syn)                                                  ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                                 ‚îÇ
‚îÇ  let input = parse_macro_input!(input as DeriveInput);            ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ  DeriveInput {                                                     ‚îÇ
‚îÇ      ident: "Agent",                                               ‚îÇ
‚îÇ      data: Struct {                                                ‚îÇ
‚îÇ          fields: [                                                 ‚îÇ
‚îÇ              Field { ident: "id", ty: u32 },                      ‚îÇ
‚îÇ              Field { ident: "name", ty: String },                 ‚îÇ
‚îÇ          ]                                                         ‚îÇ
‚îÇ      }                                                             ‚îÇ
‚îÇ  }                                                                 ‚îÇ
‚îÇ           ‚îÇ                                                         ‚îÇ
‚îÇ           ‚ñº                                                         ‚îÇ
‚îÇ  5. –ì–ï–ù–ï–†–ê–¶–Ü–Ø (quote)                                              ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                             ‚îÇ
‚îÇ  quote! {                                                          ‚îÇ
‚îÇ      impl MyTrait for Agent {                                      ‚îÇ
‚îÇ          fn describe(&self) -> String {                            ‚îÇ
‚îÇ              format!("Agent: id={}, name={}", self.id, self.name) ‚îÇ
‚îÇ          }                                                         ‚îÇ
‚îÇ      }                                                             ‚îÇ
‚îÇ  }                                                                 ‚îÇ
‚îÇ           ‚îÇ                                                         ‚îÇ
‚îÇ           ‚ñº                                                         ‚îÇ
‚îÇ  6. –ü–û–í–ï–†–ù–ï–ù–ù–Ø TokenStream                                         ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                        ‚îÇ
‚îÇ  –ù–æ–≤–∏–π TokenStream –¥–æ–¥–∞—î—Ç—å—Å—è –¥–æ –∫–æ–¥—É                              ‚îÇ
‚îÇ           ‚îÇ                                                         ‚îÇ
‚îÇ           ‚ñº                                                         ‚îÇ
‚îÇ  7. –ü–†–û–î–û–í–ñ–ï–ù–ù–Ø –ö–û–ú–ü–Ü–õ–Ø–¶–Ü–á                                         ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                                        ‚îÇ
‚îÇ  –ö–æ–º–ø—ñ–ª—è—Ç–æ—Ä –∫–æ–º–ø—ñ–ª—é—î –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É                        ‚îÇ
‚îÇ  + –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π impl                                               ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 46.4 –ï–ö–û–°–ò–°–¢–ï–ú–ê: SYN, QUOTE, PROC-MACRO2

### 46.4.1 –ü—Ä–æ–±–ª–µ–º–∞ –∑ —á–∏—Å—Ç–∏–º TokenStream

`TokenStream` —ñ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ—ó –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ ‚Äî —Ü–µ –Ω–∏–∑—å–∫–æ—Ä—ñ–≤–Ω–µ–≤–∏–π –ø–æ—Ç—ñ–∫ —Ç–æ–∫–µ–Ω—ñ–≤:

```rust
// –ë–µ–∑ –¥–æ–ø–æ–º—ñ–∂–Ω–∏—Ö –±—ñ–±–ª—ñ–æ—Ç–µ–∫
#[proc_macro_derive(MyTrait)]
pub fn my_trait_derive(input: TokenStream) -> TokenStream {
    // input ‚Äî —Ü–µ –ø–æ—Ç—ñ–∫ —Ç–æ–∫–µ–Ω—ñ–≤, —â–æ—Å—å –Ω–∞ –∫—à—Ç–∞–ª—Ç:
    // [Ident("struct"), Ident("Agent"), Punct('{'), ...]
    
    // –Ø–∫ –∑–Ω–∞–π—Ç–∏ –Ω–∞–∑–≤—É —Å—Ç—Ä—É–∫—Ç—É—Ä–∏? –Ü—Ç–µ—Ä—É–≤–∞—Ç–∏ —Ç–æ–∫–µ–Ω–∏ –≤—Ä—É—á–Ω—É?
    // –Ø–∫ –∑–Ω–∞–π—Ç–∏ –ø–æ–ª—è? –†–∞—Ö—É–≤–∞—Ç–∏ –¥—É–∂–∫–∏?
    // –Ø–∫ –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∫–æ–¥? –°–∫–ª–µ—é–≤–∞—Ç–∏ —Ä—è–¥–∫–∏?
    
    // –¶–µ –î–£–ñ–ï —Å–∫–ª–∞–¥–Ω–æ —Ç–∞ –Ω–µ–Ω–∞–¥—ñ–π–Ω–æ!
}
```

–ü—Ä–∞—Ü—é–≤–∞—Ç–∏ –∑ —á–∏—Å—Ç–∏–º `TokenStream` –Ω–∞–¥–∑–≤–∏—á–∞–π–Ω–æ –≤–∞–∂–∫–æ. –¢–æ–º—É –µ–∫–æ—Å–∏—Å—Ç–µ–º–∞ –Ω–∞–¥–∞—î –∑—Ä—É—á–Ω—ñ –∞–±—Å—Ç—Ä–∞–∫—Ü—ñ—ó.

### 46.4.2 Syn ‚Äî –ø–∞—Ä—Å–∏–Ω–≥ TokenStream –≤ AST

**Syn** ‚Äî –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞, —â–æ –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î –ø–æ—Ç—ñ–∫ —Ç–æ–∫–µ–Ω—ñ–≤ —É —Ç–∏–ø—ñ–∑–æ–≤–∞–Ω–∏–π AST (Abstract Syntax Tree):

```rust
use syn::{parse_macro_input, DeriveInput};

#[proc_macro_derive(MyTrait)]
pub fn my_trait_derive(input: TokenStream) -> TokenStream {
    // –ú–∞–≥—ñ—è! TokenStream ‚Üí —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∏–π DeriveInput
    let input = parse_macro_input!(input as DeriveInput);
    
    // –¢–µ–ø–µ—Ä –º–∞—î–º–æ —Ç–∏–ø—ñ–∑–æ–≤–∞–Ω–∏–π –¥–æ—Å—Ç—É–ø:
    let struct_name = &input.ident;        // –ù–∞–∑–≤–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏
    let fields = &input.data;               // –ü–æ–ª—è/–≤–∞—Ä—ñ–∞–Ω—Ç–∏
    let attrs = &input.attrs;               // –ê—Ç—Ä–∏–±—É—Ç–∏
    let generics = &input.generics;         // –î–∂–µ–Ω–µ—Ä–∏–∫–∏ <T, U>
    
    // ...
}
```

**–û—Å–Ω–æ–≤–Ω—ñ —Ç–∏–ø–∏ syn:**

| –¢–∏–ø | –©–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—î |
|-----|----------------|
| `DeriveInput` | –í—Ö—ñ–¥ –¥–ª—è derive –º–∞–∫—Ä–æ—Å–∞ (struct/enum) |
| `ItemStruct` | –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è struct |
| `ItemFn` | –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ—ó |
| `ItemEnum` | –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è enum |
| `Field` | –ü–æ–ª–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ |
| `Variant` | –í–∞—Ä—ñ–∞–Ω—Ç enum |
| `Expr` | –í–∏—Ä–∞–∑ |
| `Type` | –¢–∏–ø |
| `Ident` | –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä |

### 46.4.3 Quote ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è –∫–æ–¥—É

**Quote** ‚Äî –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó `TokenStream` –∑ —à–∞–±–ª–æ–Ω—ñ–≤ –∫–æ–¥—É:

```rust
use quote::quote;

let struct_name = &input.ident;  // –ü—Ä–∏–ø—É—Å—Ç–∏–º–æ, "Agent"

// quote! –≥–µ–Ω–µ—Ä—É—î TokenStream –∑ —à–∞–±–ª–æ–Ω—É Rust-–∫–æ–¥—É
let expanded = quote! {
    impl MyTrait for #struct_name {
        fn describe(&self) -> String {
            format!("I am a {}", stringify!(#struct_name))
        }
    }
};

// #struct_name ‚Äî —ñ–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü—ñ—è, –ø—ñ–¥—Å—Ç–∞–≤–ª—è—î—Ç—å—Å—è –∑–Ω–∞—á–µ–Ω–Ω—è –∑–º—ñ–Ω–Ω–æ—ó
// –†–µ–∑—É–ª—å—Ç–∞—Ç: impl MyTrait for Agent { ... }
```

**–°–∏–Ω—Ç–∞–∫—Å–∏—Å quote:**
- `#variable` ‚Äî –ø—ñ–¥—Å—Ç–∞–≤–∏—Ç–∏ –∑–Ω–∞—á–µ–Ω–Ω—è –∑–º—ñ–Ω–Ω–æ—ó
- `#(#iterable)*` ‚Äî –ø–æ–≤—Ç–æ—Ä–∏—Ç–∏ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –µ–ª–µ–º–µ–Ω—Ç–∞
- `##` ‚Äî –≤—Å—Ç–∞–≤–∏—Ç–∏ –ª—ñ—Ç–µ—Ä–∞–ª—å–Ω–∏–π `#`

### 46.4.4 Proc-macro2 ‚Äî —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å

**Proc-macro2** ‚Äî –æ–±–≥–æ—Ä—Ç–∫–∞ –Ω–∞–¥ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–º `proc_macro`, —â–æ –ø—Ä–∞—Ü—é—î –ø–æ–∑–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó. –ü–æ—Ç—Ä—ñ–±–Ω–∞ –¥–ª—è:
- –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –º–∞–∫—Ä–æ—Å—ñ–≤
- –†–æ–±–æ—Ç–∏ –≤ —ñ–Ω—à–∏—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞—Ö

Syn —Ç–∞ Quote –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å `proc_macro2` –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ, —Ç–æ–º—É –≤–∞–º –∑–∞–∑–≤–∏—á–∞–π –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –∑ –Ω–∏–º –Ω–∞–ø—Ä—è–º—É.

### 46.4.5 –¢–∏–ø–æ–≤–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ derive –º–∞–∫—Ä–æ—Å–∞

```rust
use proc_macro::TokenStream;
use quote::quote;
use syn::{parse_macro_input, DeriveInput};

#[proc_macro_derive(MyTrait)]
pub fn my_trait_derive(input: TokenStream) -> TokenStream {
    // –ö–†–û–ö 1: –ü–∞—Ä—Å–∏–Ω–≥ –≤—Ö–æ–¥—É
    let input = parse_macro_input!(input as DeriveInput);
    
    // –ö–†–û–ö 2: –í–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è –ø–æ—Ç—Ä—ñ–±–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó
    let name = &input.ident;
    
    // –ö–†–û–ö 3: –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∫–æ–¥—É
    let expanded = quote! {
        impl MyTrait for #name {
            fn my_method(&self) {
                println!("Hello from {}", stringify!(#name));
            }
        }
    };
    
    // –ö–†–û–ö 4: –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è TokenStream
    TokenStream::from(expanded)
}
```

---

## 46.5 –ü–†–ê–ö–¢–ò–ß–ù–ò–ô –ü–†–ò–ö–õ–ê–î: DERIVE –ú–ê–ö–†–û–° DESCRIBE

### 46.5.1 –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á—ñ

–°—Ç–≤–æ—Ä–∏–º–æ –º–∞–∫—Ä–æ—Å `#[derive(Describe)]`, —â–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≥–µ–Ω–µ—Ä—É—î –º–µ—Ç–æ–¥ `describe()` –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä. –ú–µ—Ç–æ–¥ –ø–æ–≤–µ—Ä—Ç–∞—Ç–∏–º–µ —Ä—è–¥–æ–∫ –∑ –Ω–∞–∑–≤–æ—é —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ —Ç–∞ –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏ –≤—Å—ñ—Ö –ø–æ–ª—ñ–≤.

```rust
// –ë–∞–∂–∞–Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:
#[derive(Describe)]
struct Agent {
    id: u32,
    name: String,
    battery: u8,
}

// –ú–∞—î –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏:
impl Agent {
    fn describe(&self) -> String {
        format!("Agent {{ id: {}, name: {}, battery: {} }}", 
                self.id, self.name, self.battery)
    }
}

// –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:
let agent = Agent { id: 1, name: "Scout".to_string(), battery: 100 };
println!("{}", agent.describe());
// Agent { id: 1, name: Scout, battery: 100 }
```

### 46.5.2 –ö—Ä–æ–∫ 1: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫—Ä–µ–π—Ç–∞ –º–∞–∫—Ä–æ—Å–∞

–°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π –∫—Ä–µ–π—Ç:

```bash
cargo new describe_macro --lib
```

–†–µ–¥–∞–≥—É—î–º–æ `Cargo.toml`:

```toml
[package]
name = "describe_macro"
version = "0.1.0"
edition = "2021"

[lib]
proc-macro = true

[dependencies]
syn = { version = "2", features = ["full"] }
quote = "1"
```

### 46.5.3 –ö—Ä–æ–∫ 2: –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –º–∞–∫—Ä–æ—Å–∞

**–ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á—ñ:** –†–µ–∞–ª—ñ–∑—É—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é –º–∞–∫—Ä–æ—Å–∞, —â–æ –ø–∞—Ä—Å–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞ –≥–µ–Ω–µ—Ä—É—î –º–µ—Ç–æ–¥ describe().

```rust
// describe_macro/src/lib.rs

use proc_macro::TokenStream;
use quote::quote;
use syn::{parse_macro_input, DeriveInput, Data, Fields};

/// Derive –º–∞–∫—Ä–æ—Å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—ó –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –º–µ—Ç–æ–¥—É describe()
#[proc_macro_derive(Describe)]
pub fn describe_derive(input: TokenStream) -> TokenStream {
    // –ö—Ä–æ–∫ 1: –ü–∞—Ä—Å–∏–º–æ –≤—Ö—ñ–¥–Ω–∏–π TokenStream —É —Å—Ç—Ä—É–∫—Ç—É—Ä—É DeriveInput
    let input = parse_macro_input!(input as DeriveInput);
    
    // –ö—Ä–æ–∫ 2: –í–∏—Ç—è–≥—É—î–º–æ –Ω–∞–∑–≤—É —Å—Ç—Ä—É–∫—Ç—É—Ä–∏
    let struct_name = &input.ident;
    
    // –ö—Ä–æ–∫ 3: –û–±—Ä–æ–±–ª—è—î–º–æ –ø–æ–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏
    let fields_description = match &input.data {
        // –¢—ñ–ª—å–∫–∏ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä –∑ —ñ–º–µ–Ω–æ–≤–∞–Ω–∏–º–∏ –ø–æ–ª—è–º–∏
        Data::Struct(data_struct) => {
            match &data_struct.fields {
                Fields::Named(fields_named) => {
                    // –ó–±–∏—Ä–∞—î–º–æ –æ–ø–∏—Å –∫–æ–∂–Ω–æ–≥–æ –ø–æ–ª—è
                    let field_formats: Vec<_> = fields_named.named.iter().map(|field| {
                        let field_name = field.ident.as_ref().unwrap();
                        // –§–æ—Ä–º—É—î–º–æ —á–∞—Å—Ç–∏–Ω—É format! –¥–ª—è —Ü—å–æ–≥–æ –ø–æ–ª—è
                        quote! {
                            format!("{}: {:?}", stringify!(#field_name), self.#field_name)
                        }
                    }).collect();
                    
                    // –û–±'—î–¥–Ω—É—î–º–æ –≤—Å—ñ –ø–æ–ª—è —á–µ—Ä–µ–∑ –∫–æ–º—É
                    quote! {
                        vec![#(#field_formats),*].join(", ")
                    }
                }
                _ => {
                    // –î–ª—è tuple structs —Ç–∞ unit structs
                    quote! { String::new() }
                }
            }
        }
        _ => {
            // –î–ª—è enum —Ç–∞ union ‚Äî –ø–æ–∫–∏ –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î–º–æ
            quote! { String::from("(unsupported type)") }
        }
    };
    
    // –ö—Ä–æ–∫ 4: –ì–µ–Ω–µ—Ä—É—î–º–æ —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π –∫–æ–¥
    let expanded = quote! {
        impl #struct_name {
            /// –ü–æ–≤–µ—Ä—Ç–∞—î –æ–ø–∏—Å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –∑ —É—Å—ñ–º–∞ –ø–æ–ª—è–º–∏
            pub fn describe(&self) -> String {
                format!("{} {{ {} }}", stringify!(#struct_name), #fields_description)
            }
        }
    };
    
    // –ö—Ä–æ–∫ 5: –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ —É TokenStream
    TokenStream::from(expanded)
}
```

### 46.5.4 –ö—Ä–æ–∫ 3: –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –º–∞–∫—Ä–æ—Å–∞

–£ —ñ–Ω—à–æ–º—É –∫—Ä–µ–π—Ç—ñ:

```toml
# Cargo.toml
[dependencies]
describe_macro = { path = "../describe_macro" }
```

```rust
// src/main.rs
use describe_macro::Describe;

#[derive(Describe)]
struct Agent {
    id: u32,
    name: String,
    battery: u8,
}

#[derive(Describe)]
struct Position {
    x: f64,
    y: f64,
}

fn main() {
    let agent = Agent {
        id: 42,
        name: "Scout".to_string(),
        battery: 85,
    };
    
    let pos = Position { x: 10.5, y: 20.3 };
    
    println!("{}", agent.describe());
    // Agent { id: 42, name: "Scout", battery: 85 }
    
    println!("{}", pos.describe());
    // Position { x: 10.5, y: 20.3 }
}
```

### 46.5.5 –†–æ–∑–±—ñ—Ä –∫–ª—é—á–æ–≤–∏—Ö –º–æ–º–µ–Ω—Ç—ñ–≤

**`parse_macro_input!(input as DeriveInput)`**

–¶–µ –º–∞–∫—Ä–æ—Å –∑ syn, —â–æ:
1. –ü–∞—Ä—Å–∏—Ç—å `TokenStream` —É –≤–∫–∞–∑–∞–Ω–∏–π —Ç–∏–ø (`DeriveInput`)
2. –ü—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ –ø–∞—Ä—Å–∏–Ω–≥—É ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≥–µ–Ω–µ—Ä—É—î compile error

**`DeriveInput` —Å—Ç—Ä—É–∫—Ç—É—Ä–∞**

```rust
pub struct DeriveInput {
    pub attrs: Vec<Attribute>,  // #[...] –∞—Ç—Ä–∏–±—É—Ç–∏
    pub vis: Visibility,        // pub/private
    pub ident: Ident,           // –ù–∞–∑–≤–∞ —Ç–∏–ø—É
    pub generics: Generics,     // <T, U>
    pub data: Data,             // Struct/Enum/Union
}
```

**`quote! { ... }` –∑ —ñ–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü—ñ—î—é**

```rust
// #struct_name –ø—ñ–¥—Å—Ç–∞–≤–ª—è—î—Ç—å—Å—è –∑–Ω–∞—á–µ–Ω–Ω—è–º –∑–º—ñ–Ω–Ω–æ—ó
quote! {
    impl #struct_name { ... }
}

// #(#items),* ‚Äî –ø–æ–≤—Ç–æ—Ä–µ–Ω–Ω—è –∑ —Ä–æ–∑–¥—ñ–ª—å–Ω–∏–∫–æ–º
quote! {
    vec![#(#items),*]
}
```

---

## 46.6 ATTRIBUTE –ú–ê–ö–†–û–°–ò

### 46.6.1 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ attribute –º–∞–∫—Ä–æ—Å–∞

Attribute –º–∞–∫—Ä–æ—Å –æ—Ç—Ä–∏–º—É—î **–¥–≤–∞** TokenStream: –∞—Ç—Ä–∏–±—É—Ç–∏ —Ç–∞ —Å–∞–º item.

```rust
use proc_macro::TokenStream;

#[proc_macro_attribute]
pub fn my_attribute(
    attr: TokenStream,   // –ê—Ä–≥—É–º–µ–Ω—Ç–∏ –∞—Ç—Ä–∏–±—É—Ç–∞: my_attribute(–¶–ï)
    item: TokenStream,   // –°–∞–º item, –¥–æ —è–∫–æ–≥–æ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ –∞—Ç—Ä–∏–±—É—Ç
) -> TokenStream {
    // –ü–æ–≤–µ—Ä—Ç–∞—î –ó–ê–ú–Ü–°–¢–¨ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ–≥–æ item
    // (–º–æ–∂–µ –≤–∫–ª—é—á–∞—Ç–∏ –æ—Ä–∏–≥—ñ–Ω–∞–ª, –º–æ–∂–µ –Ω—ñ)
}
```

### 46.6.2 –ü—Ä–∏–∫–ª–∞–¥: –ª–æ–≥—É–≤–∞–Ω–Ω—è –≤–∏–∫–ª–∏–∫—ñ–≤ —Ñ—É–Ω–∫—Ü—ñ—ó

**–ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á—ñ:** –°—Ç–≤–æ—Ä–∏–º–æ –∞—Ç—Ä–∏–±—É—Ç `#[log_calls]`, —â–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ª–æ–≥—É—î –≤—Ö—ñ–¥ —Ç–∞ –≤–∏—Ö—ñ–¥ –∑ —Ñ—É–Ω–∫—Ü—ñ—ó.

```rust
// log_macro/src/lib.rs
use proc_macro::TokenStream;
use quote::quote;
use syn::{parse_macro_input, ItemFn};

#[proc_macro_attribute]
pub fn log_calls(_attr: TokenStream, item: TokenStream) -> TokenStream {
    // –ü–∞—Ä—Å–∏–º–æ —è–∫ —Ñ—É–Ω–∫—Ü—ñ—é
    let input = parse_macro_input!(item as ItemFn);
    
    let fn_name = &input.sig.ident;
    let fn_block = &input.block;
    let fn_vis = &input.vis;
    let fn_sig = &input.sig;
    
    // –ì–µ–Ω–µ—Ä—É—î–º–æ –æ–±–≥–æ—Ä—Ç–∫—É
    let expanded = quote! {
        #fn_vis #fn_sig {
            println!("[ENTER] {}", stringify!(#fn_name));
            let __result = (|| #fn_block)();
            println!("[EXIT] {}", stringify!(#fn_name));
            __result
        }
    };
    
    TokenStream::from(expanded)
}
```

**–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:**

```rust
use log_macro::log_calls;

#[log_calls]
fn process_data(x: i32) -> i32 {
    println!("Processing: {}", x);
    x * 2
}

fn main() {
    let result = process_data(21);
    println!("Result: {}", result);
}
```

**–í–∏–≤—ñ–¥:**

```
[ENTER] process_data
Processing: 21
[EXIT] process_data
Result: 42
```

### 46.6.3 –†—ñ–∑–Ω–∏—Ü—è –º—ñ–∂ derive —Ç–∞ attribute –º–∞–∫—Ä–æ—Å–∞–º–∏

| –ê—Å–ø–µ–∫—Ç | Derive | Attribute |
|--------|--------|-----------|
| **–ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è** | –¢—ñ–ª—å–∫–∏ —Ç–∏–ø–∏ (struct, enum) | –ë—É–¥—å-—è–∫–∏–π item |
| **–©–æ –æ—Ç—Ä–∏–º—É—î** | –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ç–∏–ø—É | –í–µ—Å—å item + –∞—Ä–≥—É–º–µ–Ω—Ç–∏ |
| **–©–æ –ø–æ–≤–µ—Ä—Ç–∞—î** | –î–æ–¥–∞—Ç–∫–æ–≤–∏–π –∫–æ–¥ | –ó–∞–º—ñ–Ω–∞ –∫–æ–¥—É |
| **–û—Ä–∏–≥—ñ–Ω–∞–ª** | –ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ | –ú–∞—î –±—É—Ç–∏ –≤–∫–ª—é—á–µ–Ω–∏–π —è–≤–Ω–æ |
| **–ü—Ä–∏–∫–ª–∞–¥** | `#[derive(Debug)]` | `#[tokio::main]` |

---

## 46.7 –ü–†–ò–ö–õ–ê–î –î–õ–Ø –ú–ê–°: DERIVE AGENT

### 46.7.1 –ö–æ–Ω—Ü–µ–ø—Ü—ñ—è

–°—Ç–≤–æ—Ä–∏–º–æ `#[derive(Agent)]` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—ó —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó trait `AgentTrait`:

```rust
// –ë–∞–∂–∞–Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
#[derive(Agent)]
struct Scout {
    id: u32,
    position: Position,
    battery: u8,
}

// –ú–∞—î –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏:
impl AgentTrait for Scout {
    fn get_id(&self) -> u32 { self.id }
    fn get_battery(&self) -> u8 { self.battery }
    fn is_active(&self) -> bool { self.battery > 0 }
}
```

### 46.7.2 –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è trait

```rust
// –£ –æ—Å–Ω–æ–≤–Ω–æ–º—É –∫—Ä–µ–π—Ç—ñ
pub trait AgentTrait {
    fn get_id(&self) -> u32;
    fn get_battery(&self) -> u8;
    fn is_active(&self) -> bool;
}
```

### 46.7.3 –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –º–∞–∫—Ä–æ—Å–∞

**–ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á—ñ:** –ú–∞–∫—Ä–æ—Å —à—É–∫–∞—î –ø–æ–ª—è –∑ –ø–µ–≤–Ω–∏–º–∏ –Ω–∞–∑–≤–∞–º–∏ —Ç–∞ –≥–µ–Ω–µ—Ä—É—î —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—é trait.

```rust
// agent_derive/src/lib.rs
use proc_macro::TokenStream;
use quote::quote;
use syn::{parse_macro_input, DeriveInput, Data, Fields};

#[proc_macro_derive(Agent)]
pub fn agent_derive(input: TokenStream) -> TokenStream {
    let input = parse_macro_input!(input as DeriveInput);
    let name = &input.ident;
    
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ —Ü–µ struct –∑ —ñ–º–µ–Ω–æ–≤–∞–Ω–∏–º–∏ –ø–æ–ª—è–º–∏
    let fields = match &input.data {
        Data::Struct(data) => match &data.fields {
            Fields::Named(fields) => &fields.named,
            _ => panic!("Agent derive requires named fields"),
        },
        _ => panic!("Agent derive only supports structs"),
    };
    
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏—Ö –ø–æ–ª—ñ–≤
    let has_id = fields.iter().any(|f| {
        f.ident.as_ref().map(|i| i == "id").unwrap_or(false)
    });
    let has_battery = fields.iter().any(|f| {
        f.ident.as_ref().map(|i| i == "battery").unwrap_or(false)
    });
    
    if !has_id {
        panic!("Agent struct must have 'id' field");
    }
    if !has_battery {
        panic!("Agent struct must have 'battery' field");
    }
    
    let expanded = quote! {
        impl AgentTrait for #name {
            fn get_id(&self) -> u32 {
                self.id
            }
            
            fn get_battery(&self) -> u8 {
                self.battery
            }
            
            fn is_active(&self) -> bool {
                self.battery > 0
            }
        }
    };
    
    TokenStream::from(expanded)
}
```

---

## 46.8 –û–ë–†–û–ë–ö–ê –ü–û–ú–ò–õ–û–ö –£ –ú–ê–ö–†–û–°–ê–•

### 46.8.1 –ü—Ä–æ–±–ª–µ–º–∞ –∑ panic!

`panic!` —É –º–∞–∫—Ä–æ—Å—ñ –∑—É–ø–∏–Ω—è—î –∫–æ–º–ø—ñ–ª—è—Ü—ñ—é –∑ –Ω–µ–≤–∏—Ä–∞–∑–Ω–∏–º –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º. –ö—Ä–∞—â–µ ‚Äî –≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ compile error –∑ —Ç–æ—á–Ω–∏–º –æ–ø–∏—Å–æ–º.

### 46.8.2 compile_error! —Ç–∞ syn::Error

```rust
use syn::Error;
use quote::quote;

#[proc_macro_derive(MyTrait)]
pub fn my_trait_derive(input: TokenStream) -> TokenStream {
    let input = parse_macro_input!(input as DeriveInput);
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑ –≥–∞—Ä–Ω–∏–º –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º –ø—Ä–æ –ø–æ–º–∏–ª–∫—É
    match &input.data {
        Data::Struct(_) => { /* OK */ }
        Data::Enum(_) => {
            return Error::new_spanned(
                &input.ident,
                "MyTrait can only be derived for structs, not enums"
            )
            .to_compile_error()
            .into();
        }
        Data::Union(_) => {
            return Error::new_spanned(
                &input.ident,
                "MyTrait cannot be derived for unions"
            )
            .to_compile_error()
            .into();
        }
    }
    
    // ... –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è –∫–æ–¥—É
}
```

**`Error::new_spanned`** –ø—Ä–∏–≤'—è–∑—É—î –ø–æ–º–∏–ª–∫—É –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º—ñ—Å—Ü—è –≤ –∫–æ–¥—ñ, —â–æ –¥–∞—î —Ç–æ—á–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ–º–ø—ñ–ª—è—Ç–æ—Ä–∞ –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º —Ä—è–¥–∫–æ–º —Ç–∞ —Å—Ç–æ–≤–ø—Ü–µ–º.

---

## 46.9 –¢–ï–°–¢–£–í–ê–ù–ù–Ø –¢–ê –ù–ê–õ–ê–ì–û–î–ñ–ï–ù–ù–Ø –ú–ê–ö–†–û–°–Ü–í

### 46.9.1 cargo expand

–ù–∞–π–ø–æ—Ç—É–∂–Ω—ñ—à–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è ‚Äî `cargo expand`:

```bash
# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è
cargo install cargo-expand

# –ü–µ—Ä–µ–≥–ª—è–¥ —Ä–æ–∑–≥–æ—Ä–Ω—É—Ç–æ–≥–æ –∫–æ–¥—É
cargo expand

# –¢—ñ–ª—å–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π –º–æ–¥—É–ª—å
cargo expand module_name
```

### 46.9.2 –ü—Ä–∏–∫–ª–∞–¥ –≤–∏–≤–æ–¥—É cargo expand

```rust
// –î–æ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è
#[derive(Describe)]
struct Point {
    x: f64,
    y: f64,
}
```

```rust
// –ü—ñ—Å–ª—è cargo expand
struct Point {
    x: f64,
    y: f64,
}

impl Point {
    pub fn describe(&self) -> String {
        format!(
            "{} {{ {} }}",
            "Point",
            vec![
                format!("{}: {:?}", "x", self.x),
                format!("{}: {:?}", "y", self.y)
            ].join(", ")
        )
    }
}
```

### 46.9.3 –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –∑ trybuild

–î–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –º–∞–∫—Ä–æ—Å—ñ–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å `trybuild` ‚Äî –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è compile-time –ø–æ–≤–µ–¥—ñ–Ω–∫–∏:

```rust
#[test]
fn ui_tests() {
    let t = trybuild::TestCases::new();
    t.pass("tests/01-basic.rs");           // –ú–∞—î —Å–∫–æ–º–ø—ñ–ª—é–≤–∞—Ç–∏—Å—å
    t.compile_fail("tests/02-invalid.rs"); // –ú–∞—î –ù–ï —Å–∫–æ–º–ø—ñ–ª—é–≤–∞—Ç–∏—Å—å
}
```

---

## 46.10 –õ–ê–ë–û–†–ê–¢–û–†–ù–ê –†–û–ë–û–¢–ê

### –ú–µ—Ç–∞ —Ä–æ–±–æ—Ç–∏

–û–ø–∞–Ω—É–≤–∞—Ç–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–∏—Ö –º–∞–∫—Ä–æ—Å—ñ–≤ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—ó –∫–æ–¥—É.

### –ó–∞–≤–¥–∞–Ω–Ω—è 1: Derive –º–∞–∫—Ä–æ—Å Default (4 –±–∞–ª–∏)

–°—Ç–≤–æ—Ä—ñ—Ç—å `#[derive(MyDefault)]` —â–æ –≥–µ–Ω–µ—Ä—É—î —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—é Default –∑ –Ω—É–ª—å–æ–≤–∏–º–∏/–ø–æ—Ä–æ–∂–Ω—ñ–º–∏ –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏:

```rust
#[derive(MyDefault)]
struct Config {
    name: String,      // ‚Üí String::new()
    count: u32,        // ‚Üí 0
    enabled: bool,     // ‚Üí false
}
```

### –ó–∞–≤–¥–∞–Ω–Ω—è 2: Attribute –º–∞–∫—Ä–æ—Å timing (3 –±–∞–ª–∏)

–°—Ç–≤–æ—Ä—ñ—Ç—å `#[timing]` —â–æ –≤–∏–º—ñ—Ä—é—î —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ—ó:

```rust
#[timing]
fn slow_function() {
    std::thread::sleep(Duration::from_millis(100));
}
// –í–∏–≤–æ–¥–∏—Ç—å: slow_function took 100.5ms
```

### –ó–∞–≤–¥–∞–Ω–Ω—è 3: –ê–Ω–∞–ª—ñ–∑ —ñ—Å–Ω—É—é—á–æ–≥–æ –º–∞–∫—Ä–æ—Å–∞ (3 –±–∞–ª–∏)

–í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ `cargo expand` –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É `#[derive(Debug)]`. –û–ø–∏—à—ñ—Ç—å:
- –©–æ —Å–∞–º–µ –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è
- –Ø–∫ –æ–±—Ä–æ–±–ª—è—é—Ç—å—Å—è —Ä—ñ–∑–Ω—ñ —Ç–∏–ø–∏ –ø–æ–ª—ñ–≤
- –û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è

---

## 46.11 –†–ï–ó–Æ–ú–ï

### –ö–ª—é—á–æ–≤—ñ –∫–æ–Ω—Ü–µ–ø—Ü—ñ—ó

**–ü—Ä–æ—Ü–µ–¥—É—Ä–Ω—ñ –º–∞–∫—Ä–æ—Å–∏** ‚Äî —Ñ—É–Ω–∫—Ü—ñ—ó Rust, —â–æ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º—É—é—Ç—å TokenStream –ø—ñ–¥ —á–∞—Å –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó.

**–¢—Ä–∏ —Ç–∏–ø–∏:**
1. **Derive** ‚Äî `#[derive(Trait)]` ‚Äî –¥–æ–¥–∞—î —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó
2. **Attribute** ‚Äî `#[attr]` ‚Äî —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º—É—î item
3. **Function-like** ‚Äî `macro!()` ‚Äî DSL

**–ï–∫–æ—Å–∏—Å—Ç–µ–º–∞:**
- **syn** ‚Äî –ø–∞—Ä—Å–∏–Ω–≥ TokenStream –≤ AST
- **quote** ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è –∫–æ–¥—É –∑ —à–∞–±–ª–æ–Ω—ñ–≤
- **proc-macro2** ‚Äî —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å

**–û–±–æ–≤'—è–∑–∫–æ–≤—ñ –≤–∏–º–æ–≥–∏:**
- –û–∫—Ä–µ–º–∏–π –∫—Ä–µ–π—Ç –∑ `proc-macro = true`
- –ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ: syn, quote

### –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∑ –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–∏–º–∏

| –ö—Ä–∏—Ç–µ—Ä—ñ–π | –î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ñ | –ü—Ä–æ—Ü–µ–¥—É—Ä–Ω—ñ |
|----------|--------------|------------|
| –°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å | –ù–∏–∑—å–∫–∞ | –í–∏—Å–æ–∫–∞ |
| –ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ | –û–±–º–µ–∂–µ–Ω—ñ | –ü–æ–≤–Ω—ñ |
| Derive | ‚ùå | ‚úÖ |
| –ê–Ω–∞–ª—ñ–∑ —Ç–∏–ø—ñ–≤ | ‚ùå | ‚úÖ |

---

## üîó –ó–í'–Ø–ó–û–ö –ó –ù–ê–°–¢–£–ü–ù–ò–ú –†–û–ó–î–Ü–õ–û–ú

–í–∏ –æ–ø–∞–Ω—É–≤–∞–ª–∏ –º–µ—Ç–∞–ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è ‚Äî –∫–æ–¥, —â–æ –ø–∏—à–µ –∫–æ–¥. –ê–ª–µ –≤–µ—Å—å —Ü–µ–π –∫–æ–¥ –ø—Ä–∞—Ü—é—î –≤ –º–µ–∂–∞—Ö **safe Rust** ‚Äî –∑ –≥–∞—Ä–∞–Ω—Ç—ñ—è–º–∏ –±–µ–∑–ø–µ–∫–∏ –ø–∞–º'—è—Ç—ñ.

–©–æ —Ä–æ–±–∏—Ç–∏, –∫–æ–ª–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ:
- –ü—Ä–∞—Ü—é–≤–∞—Ç–∏ –∑ raw pointers
- –í–∏–∫–ª–∏–∫–∞—Ç–∏ C –∫–æ–¥
- –†–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –Ω–∏–∑—å–∫–æ—Ä—ñ–≤–Ω–µ–≤—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –¥–∞–Ω–∏—Ö

–î–ª—è —Ü—å–æ–≥–æ —ñ—Å–Ω—É—î **unsafe Rust** ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª—å–æ–≤–∞–Ω–∏–π –≤–∏—Ö—ñ–¥ –∑–∞ –º–µ–∂—ñ –±–µ–∑–ø–µ–∫–∏.

–£ **–†–æ–∑–¥—ñ–ª—ñ 47: Unsafe Rust ‚Äî –ú–µ–∂—ñ –±–µ–∑–ø–µ–∫–∏** –≤–∏:
- –ó—Ä–æ–∑—É–º—ñ—î—Ç–µ, —â–æ —Ç–∞–∫–µ unsafe —ñ –Ω–∞–≤—ñ—â–æ –≤—ñ–Ω –ø–æ—Ç—Ä—ñ–±–µ–Ω
- –î—ñ–∑–Ω–∞—î—Ç–µ—Å—å –ø—Ä–æ "—Å—É–ø–µ—Ä—Å–∏–ª–∏" unsafe
- –ù–∞–≤—á–∏—Ç–µ—Å—å –º—ñ–Ω—ñ–º—ñ–∑—É–≤–∞—Ç–∏ unsafe surface
- –ü–æ–±–∞—á–∏—Ç–µ, —è–∫ unsafe –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó –∑ hardware

---

> **–ù–∞—Å—Ç—É–ø–Ω–∏–π —Ä–æ–∑–¥—ñ–ª:** [–†–æ–∑–¥—ñ–ª 47: Unsafe Rust ‚Äî –ú–µ–∂—ñ –±–µ–∑–ø–µ–∫–∏](./47_Unsafe.md)
