# –†–æ–∑–¥—ñ–ª 31: Cell<T> —Ç–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∏ RefCell

---

## üìã –ê–Ω–æ—Ç–∞—Ü—ñ—è

RefCell –ø–æ—Ç—É–∂–Ω–∏–π, –∞–ª–µ –º–∞—î –Ω–∞–∫–ª–∞–¥–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏: –¥–∏–Ω–∞–º—ñ—á–Ω–µ –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –ø–æ–∑–∏—á–∞–Ω—å, –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –ø–∞–Ω—ñ–∫–∏, –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è Ref/RefMut –æ–±–≥–æ—Ä—Ç–æ–∫. –î–ª—è –ø—Ä–æ—Å—Ç–∏—Ö –≤–∏–ø–∞–¥–∫—ñ–≤ ‚Äî –ª—ñ—á–∏–ª—å–Ω–∏–∫—ñ–≤, –ø—Ä–∞–ø–æ—Ä—Ü—ñ–≤, –ø—Ä–∏–º—ñ—Ç–∏–≤–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω—å ‚Äî —Ü–µ –Ω–∞–¥–º—ñ—Ä–Ω–æ.

**Cell<T>** ‚Äî –ª–µ–≥—à–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –¥–ª—è —Ç–∏–ø—ñ–≤, —â–æ —Ä–µ–∞–ª—ñ–∑—É—é—Ç—å Copy. –ó–∞–º—ñ—Å—Ç—å –ø–æ–∑–∏—á–∞–Ω–Ω—è ‚Äî –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è: `get()` –ø–æ–≤–µ—Ä—Ç–∞—î –∫–æ–ø—ñ—é –∑–Ω–∞—á–µ–Ω–Ω—è, `set()` –∑–∞–º—ñ–Ω—é—î –π–æ–≥–æ –ø–æ–≤–Ω—ñ—Å—Ç—é. –ñ–æ–¥–Ω–∏—Ö –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫ –ø—ñ–¥ —á–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è, –∂–æ–¥–Ω–∏—Ö –ø–∞–Ω—ñ–∫–∏, –º—ñ–Ω—ñ–º–∞–ª—å–Ω—ñ –Ω–∞–∫–ª–∞–¥–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏.

–£ —Ü—å–æ–º—É —Ä–æ–∑–¥—ñ–ª—ñ –≤–∏ —Ç–∞–∫–æ–∂ –ø–æ–∑–Ω–∞–π–æ–º–∏—Ç–µ—Å—å –∑ **OnceCell** —Ç–∞ **LazyCell** ‚Äî —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–º–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏ –¥–ª—è –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ—ó —Ç–∞ –ª—ñ–Ω–∏–≤–æ—ó —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó. –†–∞–∑–æ–º —Ü—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –ø–æ–∫—Ä–∏–≤–∞—é—Ç—å –±—ñ–ª—å—à—ñ—Å—Ç—å –ø–æ—Ç—Ä–µ–± –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ—ó –º—É—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ.

---

## üéØ –¶—ñ–ª—ñ –Ω–∞–≤—á–∞–Ω–Ω—è

–ü—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ü—å–æ–≥–æ —Ä–æ–∑–¥—ñ–ª—É –≤–∏ –∑–º–æ–∂–µ—Ç–µ:

1. **–†–æ–∑—É–º—ñ—Ç–∏** —Ä—ñ–∑–Ω–∏—Ü—é –º—ñ–∂ Cell —Ç–∞ RefCell
2. **–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏** Cell –¥–ª—è Copy —Ç–∏–ø—ñ–≤
3. **–ó–∞—Å—Ç–æ—Å–æ–≤—É–≤–∞—Ç–∏** OnceCell –¥–ª—è –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ—ó —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
4. **–û–±–∏—Ä–∞—Ç–∏** –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å–∏—Ç—É–∞—Ü—ñ—ó
5. **–†–æ–∑—É–º—ñ—Ç–∏** –∫–æ–º–ø—Ä–æ–º—ñ—Å–∏ –∫–æ–∂–Ω–æ–≥–æ –ø—ñ–¥—Ö–æ–¥—É

---

## üìö –ö–ª—é—á–æ–≤—ñ —Ç–µ—Ä–º—ñ–Ω–∏

| –¢–µ—Ä–º—ñ–Ω | –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è |
|--------|------------|
| **Cell<T>** | –í–Ω—É—Ç—Ä—ñ—à–Ω—è –º—É—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å —á–µ—Ä–µ–∑ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è |
| **Copy** | Trait –¥–ª—è —Ç–∏–ø—ñ–≤ –∑ –ø–æ–±—ñ—Ç–æ–≤–∏–º –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è–º |
| **OnceCell<T>** | –ö–æ–º—ñ—Ä–∫–∞ –∑ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ—é —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—î—é |
| **LazyCell<T>** | –õ—ñ–Ω–∏–≤–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –¥–æ—Å—Ç—É–ø—ñ |
| **get/set** | –ú–µ—Ç–æ–¥–∏ Cell –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è/–∑–∞–ø–∏—Å—É |

---

## üí° –ú–æ—Ç–∏–≤–∞—Ü—ñ–π–Ω–∏–π –∫–µ–π—Å: –ü—Ä–æ—Å—Ç–∏–π –ª—ñ—á–∏–ª—å–Ω–∏–∫

```rust
use std::cell::RefCell;

// ‚ùå RefCell –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ u32 ‚Äî –Ω–∞–¥–º—ñ—Ä–Ω–æ
struct Counter {
    value: RefCell<u32>,
}

impl Counter {
    fn increment(&self) {
        *self.value.borrow_mut() += 1;  // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, Ref –æ–±–≥–æ—Ä—Ç–∫–∞
    }
}

// ‚úÖ Cell ‚Äî –ø—Ä–æ—Å—Ç—ñ—à–µ —Ç–∞ –µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—à–µ
use std::cell::Cell;

struct Counter {
    value: Cell<u32>,
}

impl Counter {
    fn increment(&self) {
        self.value.set(self.value.get() + 1);  // –ü—Ä–æ—Å—Ç–æ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è
    }
}
```

---

## 31.1 CELL: –ú–£–¢–ê–ë–ï–õ–¨–ù–Ü–°–¢–¨ –ß–ï–†–ï–ó –ö–û–ü–Ü–Æ–í–ê–ù–ù–Ø

### 31.1.1 –Ø–∫ –ø—Ä–∞—Ü—é—î Cell

Cell –ø—Ä–∞—Ü—é—î —ñ–Ω–∞–∫—à–µ, –Ω—ñ–∂ RefCell:
- **RefCell**: –≤–∏–¥–∞—î –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –≤–Ω—É—Ç—Ä—ñ—à–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è
- **Cell**: –∫–æ–ø—ñ—é—î –∑–Ω–∞—á–µ–Ω–Ω—è —Ç—É–¥–∏-—Å—é–¥–∏

```
RefCell<T>:  &self ‚Üí &T –∞–±–æ &mut T (–ø–æ–∑–∏—á–∞–Ω–Ω—è)
Cell<T>:     &self ‚Üí T (–∫–æ–ø—ñ—è) –∞–±–æ –∑–∞–º—ñ–Ω–∞ –∑–Ω–∞—á–µ–Ω–Ω—è
```

–û—Å–∫—ñ–ª—å–∫–∏ –≤–∏ –Ω—ñ–∫–æ–ª–∏ –Ω–µ –æ—Ç—Ä–∏–º—É—î—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –≤–Ω—É—Ç—Ä—ñ—à–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è, –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤ –ø–æ–∑–∏—á–∞–Ω–Ω—è –±—É—Ç–∏ –Ω–µ –º–æ–∂–µ.

### 31.1.2 –ë–∞–∑–æ–≤–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

```rust
use std::cell::Cell;

fn main() {
    let cell = Cell::new(42);
    
    // –ß–∏—Ç–∞–Ω–Ω—è ‚Äî –ø–æ–≤–µ—Ä—Ç–∞—î –ö–û–ü–Ü–Æ
    let value = cell.get();
    println!("Value: {}", value);  // 42
    
    // –ó–∞–ø–∏—Å ‚Äî –ó–ê–ú–Ü–ù–Æ–Ñ –∑–Ω–∞—á–µ–Ω–Ω—è
    cell.set(100);
    println!("New value: {}", cell.get());  // 100
    
    // –ú–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—è
    cell.set(cell.get() + 1);
    println!("Incremented: {}", cell.get());  // 101
}
```

### 31.1.3 –û–±–º–µ–∂–µ–Ω–Ω—è: —Ç—ñ–ª—å–∫–∏ Copy —Ç–∏–ø–∏

Cell –≤–∏–º–∞–≥–∞—î, —â–æ–± T —Ä–µ–∞–ª—ñ–∑–æ–≤—É–≤–∞–≤ Copy:

```rust
use std::cell::Cell;

// ‚úÖ –ü—Ä–∏–º—ñ—Ç–∏–≤–Ω—ñ —Ç–∏–ø–∏ ‚Äî Copy
let num: Cell<i32> = Cell::new(5);
let flag: Cell<bool> = Cell::new(true);
let char_cell: Cell<char> = Cell::new('A');

// ‚úÖ –ö–æ—Ä—Ç–µ–∂—ñ Copy —Ç–∏–ø—ñ–≤ ‚Äî Copy
let pair: Cell<(i32, i32)> = Cell::new((10, 20));

// ‚ùå String –Ω–µ Copy ‚Äî –Ω–µ –∫–æ–º–ø—ñ–ª—é—î—Ç—å—Å—è
// let string: Cell<String> = Cell::new(String::from("hello"));

// ‚ùå Vec –Ω–µ Copy
// let vec: Cell<Vec<i32>> = Cell::new(vec![1, 2, 3]);
```

### 31.1.4 –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è Cell —Ç–∞ RefCell

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ | Cell<T> | RefCell<T> |
|----------------|---------|------------|
| –û–±–º–µ–∂–µ–Ω–Ω—è —Ç–∏–ø—É | T: Copy | –ë—É–¥—å-—è–∫–∏–π T |
| –î–æ—Å—Ç—É–ø | –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è | –ü–æ–∑–∏—á–∞–Ω–Ω—è |
| –ù–∞–∫–ª–∞–¥–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏ | –ú—ñ–Ω—ñ–º–∞–ª—å–Ω—ñ | –õ—ñ—á–∏–ª—å–Ω–∏–∫ –ø–æ–∑–∏—á–∞–Ω—å |
| –ü–∞–Ω—ñ–∫–∞ | –ù–µ–º–æ–∂–ª–∏–≤–∞ | –ü—Ä–∏ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ |
| –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è | –ü—Ä–∏–º—ñ—Ç–∏–≤–∏, –ø—Ä–∞–ø–æ—Ä—Ü—ñ | –°–∫–ª–∞–¥–Ω—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ |

---

## 31.2 –ú–ï–¢–û–î–ò CELL

### 31.2.1 –û—Å–Ω–æ–≤–Ω—ñ –º–µ—Ç–æ–¥–∏

```rust
use std::cell::Cell;

fn main() {
    let cell = Cell::new(10);
    
    // get() ‚Äî –æ—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–ø—ñ—é
    let val = cell.get();
    
    // set() ‚Äî –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –Ω–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è
    cell.set(20);
    
    // replace() ‚Äî –∑–∞–º—ñ–Ω–∏—Ç–∏ —Ç–∞ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ —Å—Ç–∞—Ä–µ
    let old = cell.replace(30);
    println!("Old: {}, New: {}", old, cell.get());  // Old: 20, New: 30
    
    // take() ‚Äî –∑–∞–±—Ä–∞—Ç–∏ –∑–Ω–∞—á–µ–Ω–Ω—è, –∑–∞–ª–∏—à–∏—Ç–∏ Default
    let taken = cell.take();  // –ü–æ—Ç—Ä–µ–±—É—î T: Default
    println!("Taken: {}, Cell: {}", taken, cell.get());  // Taken: 30, Cell: 0
    
    // swap() ‚Äî –æ–±–º—ñ–Ω –º—ñ–∂ –¥–≤–æ–º–∞ Cell
    let cell2 = Cell::new(100);
    cell.swap(&cell2);
    println!("cell: {}, cell2: {}", cell.get(), cell2.get());
}
```

### 31.2.2 update() –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—ó –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—ó

```rust
use std::cell::Cell;

fn main() {
    let cell = Cell::new(5);
    
    // update() ‚Äî –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é
    cell.update(|x| x * 2);
    println!("Doubled: {}", cell.get());  // 10
    
    // –ö–æ—Ä–∏—Å–Ω–æ –¥–ª—è —Å–∫–ª–∞–¥–Ω—ñ—à–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π
    cell.update(|x| if x > 5 { x - 1 } else { x + 1 });
}
```

---

## 31.3 CELL –î–õ–Ø –ê–ì–ï–ù–¢–ê

### 31.3.1 –õ—ñ—á–∏–ª—å–Ω–∏–∫–∏ —Ç–∞ –ø—Ä–∞–ø–æ—Ä—Ü—ñ

```rust
use std::cell::Cell;

struct Agent {
    id: String,
    // –õ—ñ—á–∏–ª—å–Ω–∏–∫–∏ ‚Äî —ñ–¥–µ–∞–ª—å–Ω—ñ –¥–ª—è Cell
    steps_taken: Cell<u32>,
    scans_performed: Cell<u32>,
    
    // –ü—Ä–∞–ø–æ—Ä—Ü—ñ
    is_active: Cell<bool>,
    needs_charging: Cell<bool>,
    
    // –ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω (enum –∑ Copy)
    battery_level: Cell<u8>,
}

impl Agent {
    fn new(id: &str) -> Self {
        Self {
            id: id.to_string(),
            steps_taken: Cell::new(0),
            scans_performed: Cell::new(0),
            is_active: Cell::new(true),
            needs_charging: Cell::new(false),
            battery_level: Cell::new(100),
        }
    }
    
    fn step(&self) {
        self.steps_taken.set(self.steps_taken.get() + 1);
        self.consume_battery(1);
    }
    
    fn scan(&self) {
        self.scans_performed.set(self.scans_performed.get() + 1);
        self.consume_battery(5);
    }
    
    fn consume_battery(&self, amount: u8) {
        let new_level = self.battery_level.get().saturating_sub(amount);
        self.battery_level.set(new_level);
        
        if new_level < 20 {
            self.needs_charging.set(true);
        }
    }
    
    fn deactivate(&self) {
        self.is_active.set(false);
    }
    
    fn status(&self) -> String {
        format!(
            "{}: battery={}%, steps={}, scans={}, active={}",
            self.id,
            self.battery_level.get(),
            self.steps_taken.get(),
            self.scans_performed.get(),
            self.is_active.get()
        )
    }
}

fn main() {
    let agent = Agent::new("SCOUT-001");
    
    agent.step();
    agent.step();
    agent.scan();
    
    println!("{}", agent.status());
}
```

### 31.3.2 –ö–µ—à—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Å—Ç–∏—Ö –∑–Ω–∞—á–µ–Ω—å

```rust
use std::cell::Cell;

struct DistanceCalculator {
    last_from: Cell<(i32, i32)>,
    last_to: Cell<(i32, i32)>,
    cached_distance: Cell<Option<f64>>,
}

impl DistanceCalculator {
    fn new() -> Self {
        Self {
            last_from: Cell::new((0, 0)),
            last_to: Cell::new((0, 0)),
            cached_distance: Cell::new(None),
        }
    }
    
    fn distance(&self, from: (i32, i32), to: (i32, i32)) -> f64 {
        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–µ—à
        if from == self.last_from.get() && to == self.last_to.get() {
            if let Some(d) = self.cached_distance.get() {
                return d;
            }
        }
        
        // –û–±—á–∏—Å–ª—é—î–º–æ
        let dx = (to.0 - from.0) as f64;
        let dy = (to.1 - from.1) as f64;
        let dist = (dx * dx + dy * dy).sqrt();
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –∫–µ—à
        self.last_from.set(from);
        self.last_to.set(to);
        self.cached_distance.set(Some(dist));
        
        dist
    }
}
```

---

## 31.4 ONCECELL: –û–î–ù–û–†–ê–ó–û–í–ê –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø

### 31.4.1 –ö–æ–Ω—Ü–µ–ø—Ü—ñ—è

OnceCell ‚Äî –∫–æ–º—ñ—Ä–∫–∞, —è–∫–∞ –º–æ–∂–µ –±—É—Ç–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω —Ä–∞–∑:

```rust
use std::cell::OnceCell;

fn main() {
    let cell: OnceCell<String> = OnceCell::new();
    
    // –°–ø–æ—á–∞—Ç–∫—É –ø–æ—Ä–æ–∂–Ω—è
    assert!(cell.get().is_none());
    
    // –ü–µ—Ä—à–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è ‚Äî —É—Å–ø—ñ—Ö
    cell.set(String::from("Hello")).unwrap();
    
    // –î—Ä—É–≥–∞ —Å–ø—Ä–æ–±–∞ ‚Äî –ø–æ–º–∏–ª–∫–∞
    let result = cell.set(String::from("World"));
    assert!(result.is_err());
    
    // –ó–Ω–∞—á–µ–Ω–Ω—è –Ω–µ –∑–º—ñ–Ω–∏–ª–æ—Å—å
    println!("{}", cell.get().unwrap());  // "Hello"
}
```

### 31.4.2 get_or_init ‚Äî –ª—ñ–Ω–∏–≤–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è

```rust
use std::cell::OnceCell;

fn main() {
    let cell: OnceCell<String> = OnceCell::new();
    
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î—Ç—å—Å—è –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –≤–∏–∫–ª–∏–∫—É
    let value = cell.get_or_init(|| {
        println!("Initializing...");
        String::from("Computed value")
    });
    println!("First: {}", value);
    
    // –î—Ä—É–≥–∏–π –≤–∏–∫–ª–∏–∫ ‚Äî –ø–æ–≤–µ—Ä—Ç–∞—î —ñ—Å–Ω—É—é—á–µ, –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î
    let value = cell.get_or_init(|| {
        println!("This won't print");
        String::from("Never used")
    });
    println!("Second: {}", value);
}
// –í–∏–≤—ñ–¥:
// Initializing...
// First: Computed value
// Second: Computed value
```

### 31.4.3 OnceCell –¥–ª—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –∞–≥–µ–Ω—Ç–∞

```rust
use std::cell::OnceCell;

struct Agent {
    id: String,
    // –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –¥–æ—Å—Ç—É–ø—ñ
    config: OnceCell<AgentConfig>,
}

struct AgentConfig {
    max_speed: f64,
    scan_radius: f64,
}

impl Agent {
    fn new(id: &str) -> Self {
        Self {
            id: id.to_string(),
            config: OnceCell::new(),
        }
    }
    
    fn config(&self) -> &AgentConfig {
        self.config.get_or_init(|| {
            println!("Loading config for {}...", self.id);
            // –¢—É—Ç –º–æ–≥–ª–æ –± –±—É—Ç–∏ —á–∏—Ç–∞–Ω–Ω—è –∑ —Ñ–∞–π–ª—É
            AgentConfig {
                max_speed: 10.0,
                scan_radius: 50.0,
            }
        })
    }
    
    fn max_speed(&self) -> f64 {
        self.config().max_speed
    }
}

fn main() {
    let agent = Agent::new("SCOUT-001");
    
    // –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è —â–µ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞
    println!("Agent created");
    
    // –ü–µ—Ä—à–∏–π –¥–æ—Å—Ç—É–ø ‚Äî –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
    println!("Max speed: {}", agent.max_speed());
    
    // –î—Ä—É–≥–∏–π –¥–æ—Å—Ç—É–ø ‚Äî –∑ –∫–µ—à—É
    println!("Max speed again: {}", agent.max_speed());
}
```

---

## 31.5 LAZYCELL: –õ–Ü–ù–ò–í–ê –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø

### 31.5.1 –ö–æ–Ω—Ü–µ–ø—Ü—ñ—è

LazyCell –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î—Ç—å—Å—è –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –¥–æ—Å—Ç—É–ø—ñ:

```rust
use std::cell::LazyCell;

fn main() {
    // –§—É–Ω–∫—Ü—ñ—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ
    let lazy: LazyCell<String> = LazyCell::new(|| {
        println!("Computing...");
        String::from("Lazy value")
    });
    
    println!("LazyCell created");
    
    // –î–æ—Å—Ç—É–ø –≤–∏–∫–ª–∏–∫–∞—î —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—é
    println!("Value: {}", *lazy);
    
    // –ü–æ–≤—Ç–æ—Ä–Ω–∏–π –¥–æ—Å—Ç—É–ø ‚Äî –±–µ–∑ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
    println!("Value again: {}", *lazy);
}
// –í–∏–≤—ñ–¥:
// LazyCell created
// Computing...
// Value: Lazy value
// Value again: Lazy value
```

### 31.5.2 –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è OnceCell —Ç–∞ LazyCell

| –ê—Å–ø–µ–∫—Ç | OnceCell | LazyCell |
|--------|----------|----------|
| –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è | –Ø–≤–Ω–∞ (set, get_or_init) | –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø—ñ |
| –§—É–Ω–∫—Ü—ñ—è | –ü–µ—Ä–µ–¥–∞—î—Ç—å—Å—è –ø—Ä–∏ –≤–∏–∫–ª–∏–∫—É | –ü–µ—Ä–µ–¥–∞—î—Ç—å—Å—è –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ |
| –ì–Ω—É—á–∫—ñ—Å—Ç—å | –í–∏—â–∞ | –ù–∏–∂—á–∞ |
| –ó—Ä—É—á–Ω—ñ—Å—Ç—å | –ü–æ—Ç—Ä—ñ–±–µ–Ω –≤–∏–∫–ª–∏–∫ –º–µ—Ç–æ–¥—É | –ü—Ä–æ—Å—Ç–æ Deref |

---

## 31.6 –í–ò–ë–Ü–† –Ü–ù–°–¢–†–£–ú–ï–ù–¢–£

### 31.6.1 –î–µ—Ä–µ–≤–æ –ø—Ä–∏–π–Ω—è—Ç—Ç—è —Ä—ñ—à–µ–Ω—å

```
–ß–∏ —Ç–∏–ø T —Ä–µ–∞–ª—ñ–∑—É—î Copy?
‚îú‚îÄ –¢–∞–∫ ‚Üí –ß–∏ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è?
‚îÇ        ‚îú‚îÄ –¢–∞–∫ ‚Üí OnceCell<T>
‚îÇ        ‚îî‚îÄ –ù—ñ  ‚Üí Cell<T>
‚îÇ
‚îî‚îÄ –ù—ñ  ‚Üí –ß–∏ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è?
         ‚îú‚îÄ –¢–∞–∫ ‚Üí OnceCell<T>
         ‚îî‚îÄ –ù—ñ  ‚Üí RefCell<T>
```

### 31.6.2 –¢–∞–±–ª–∏—Ü—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è

| –¢–∏–ø | Copy –ø–æ—Ç—Ä—ñ–±–µ–Ω | –ü–∞–Ω—ñ–∫–∞ –º–æ–∂–ª–∏–≤–∞ | –ù–∞–∫–ª–∞–¥–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏ | –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è |
|-----|---------------|----------------|------------------|--------------|
| Cell<T> | –¢–∞–∫ | –ù—ñ | –ú—ñ–Ω—ñ–º–∞–ª—å–Ω—ñ | –õ—ñ—á–∏–ª—å–Ω–∏–∫–∏, –ø—Ä–∞–ø–æ—Ä—Ü—ñ |
| RefCell<T> | –ù—ñ | –¢–∞–∫ | –°–µ—Ä–µ–¥–Ω—ñ | –°–∫–ª–∞–¥–Ω—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ |
| OnceCell<T> | –ù—ñ | –ù—ñ | –ú—ñ–Ω—ñ–º–∞–ª—å–Ω—ñ | –û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è |
| LazyCell<T> | –ù—ñ | –ù—ñ | –ú—ñ–Ω—ñ–º–∞–ª—å–Ω—ñ | –õ—ñ–Ω–∏–≤–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è |

### 31.6.3 –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó

```rust
use std::cell::{Cell, RefCell, OnceCell};

struct OptimalAgent {
    id: String,
    
    // Cell –¥–ª—è –ø—Ä–∏–º—ñ—Ç–∏–≤—ñ–≤
    battery: Cell<u8>,
    step_count: Cell<u32>,
    is_active: Cell<bool>,
    
    // RefCell –¥–ª—è —Å–∫–ª–∞–¥–Ω–∏—Ö —Ç–∏–ø—ñ–≤, —â–æ –∑–º—ñ–Ω—é—é—Ç—å—Å—è
    path: RefCell<Vec<(f64, f64)>>,
    log: RefCell<Vec<String>>,
    
    // OnceCell –¥–ª—è –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ—ó —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
    config: OnceCell<Config>,
    cached_id_hash: OnceCell<u64>,
}

struct Config {
    // ...
}
```

---

## 31.7 –õ–ê–ë–û–†–ê–¢–û–†–ù–ê –†–û–ë–û–¢–ê

### –ú–µ—Ç–∞ —Ä–æ–±–æ—Ç–∏
–û–±—Ä–∞—Ç–∏ —Ç–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ç–∏–ø –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ—ó –º—É—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—ñ.

### –ó–∞–≤–¥–∞–Ω–Ω—è 1: –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –∞–≥–µ–Ω—Ç–∞ (4 –±–∞–ª–∏)

–ü–µ—Ä–µ—Ä–æ–±—ñ—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∞–≥–µ–Ω—Ç–∞, –∑–∞–º—ñ–Ω–∏–≤—à–∏ RefCell –Ω–∞ Cell —Ç–∞–º, –¥–µ –º–æ–∂–ª–∏–≤–æ:

```rust
// –î–æ:
struct Agent {
    battery: RefCell<u8>,
    position: RefCell<(f64, f64)>,
    log: RefCell<Vec<String>>,
}

// –ü—ñ—Å–ª—è: –æ–ø—Ç–∏–º—ñ–∑—É–π—Ç–µ
```

### –ó–∞–≤–¥–∞–Ω–Ω—è 2: –õ—ñ–Ω–∏–≤–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è (3 –±–∞–ª–∏)

–†–µ–∞–ª—ñ–∑—É–π—Ç–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó —á–µ—Ä–µ–∑ OnceCell:

```rust
struct System {
    config: OnceCell<SystemConfig>,
}

impl System {
    fn config(&self) -> &SystemConfig;  // –õ—ñ–Ω–∏–≤–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
}
```

### –ó–∞–≤–¥–∞–Ω–Ω—è 3: –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ (3 –±–∞–ª–∏)

–ù–∞–ø–∏—à—ñ—Ç—å –±–µ–Ω—á–º–∞—Ä–∫, —â–æ –ø–æ—Ä—ñ–≤–Ω—é—î:
- Cell<u32> increment
- RefCell<u32> increment
- –ó–≤–∏—á–∞–π–Ω–∏–π &mut increment

---

## 31.8 TROUBLESHOOTING

### –ü–æ–º–∏–ª–∫–∞: "the trait `Copy` is not implemented"

**–ü—Ä–∏—á–∏–Ω–∞:** Cell –≤–∏–º–∞–≥–∞—î Copy.

**–†—ñ—à–µ–Ω–Ω—è:** –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ RefCell –∞–±–æ –∑—Ä–æ–±—ñ—Ç—å —Ç–∏–ø Copy.

### –ü–∏—Ç–∞–Ω–Ω—è: –ö–æ–ª–∏ OnceCell, –∫–æ–ª–∏ LazyCell?

**OnceCell:** –∫–æ–ª–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –º–æ–∂–µ –ø—Ä–æ–≤–∞–ª–∏—Ç–∏—Å—å –∞–±–æ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤.

**LazyCell:** –∫–æ–ª–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ —É—Å–ø—ñ—à–Ω–∞ —ñ –Ω–µ –ø–æ—Ç—Ä–µ–±—É—î –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤.

---

## ‚úÖ –¢–ï–°–¢–ò –î–õ–Ø –°–ê–ú–û–ü–ï–†–ï–í–Ü–†–ö–ò

**1.** –ß–æ–º—É Cell –Ω–µ –º–æ–∂–µ —Å–ø—Ä–∏—á–∏–Ω–∏—Ç–∏ –ø–∞–Ω—ñ–∫—É?

<details>
<summary>–í—ñ–¥–ø–æ–≤—ñ–¥—å</summary>

Cell –Ω–µ –≤–∏–¥–∞—î –ø–æ—Å–∏–ª–∞–Ω—å –Ω–∞ –≤–Ω—É—Ç—Ä—ñ—à–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è ‚Äî —Ç—ñ–ª—å–∫–∏ –∫–æ–ø—ñ—é—î. –ë–µ–∑ –ø–æ—Å–∏–ª–∞–Ω—å –Ω–µ–º–∞—î –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤ –ø–æ–∑–∏—á–∞–Ω–Ω—è, –Ω–µ–º–∞—î —á–æ–≥–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏.
</details>

**2.** –ö–æ–ª–∏ –æ–±—Ä–∞—Ç–∏ OnceCell –∑–∞–º—ñ—Å—Ç—å LazyCell?

<details>
<summary>–í—ñ–¥–ø–æ–≤—ñ–¥—å</summary>

–ö–æ–ª–∏ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –≥–Ω—É—á–∫—ñ—Å—Ç—å: –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —Ä—ñ–∑–Ω–∏–º–∏ –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏, –æ–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ –ø—Ä–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó, –∞–±–æ –∫–æ–ª–∏ —Ñ—É–Ω–∫—Ü—ñ—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –ø–æ—Ç—Ä–µ–±—É—î –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤.
</details>

---

## üìù –†–ï–ó–Æ–ú–ï

### –©–æ –≤–∏ –≤–∏–≤—á–∏–ª–∏

1. **Cell<T>** ‚Äî –º—É—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å —á–µ—Ä–µ–∑ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è
2. **–û–±–º–µ–∂–µ–Ω–Ω—è Copy** ‚Äî —Ç—ñ–ª—å–∫–∏ –¥–ª—è –ø—Ä–æ—Å—Ç–∏—Ö —Ç–∏–ø—ñ–≤
3. **OnceCell<T>** ‚Äî –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
4. **LazyCell<T>** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –ª—ñ–Ω–∏–≤–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
5. **–í–∏–±—ñ—Ä —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É** ‚Äî –¥–µ—Ä–µ–≤–æ —Ä—ñ—à–µ–Ω—å

### –ö–ª—é—á–æ–≤—ñ –ø—Ä–∞–≤–∏–ª–∞

- ‚úÖ Cell –¥–ª—è Copy —Ç–∏–ø—ñ–≤ (–ª—ñ—á–∏–ª—å–Ω–∏–∫–∏, –ø—Ä–∞–ø–æ—Ä—Ü—ñ)
- ‚úÖ RefCell –¥–ª—è –Ω–µ-Copy —Ç–∏–ø—ñ–≤
- ‚úÖ OnceCell –¥–ª—è –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ—ó —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
- ‚úÖ –û–±–∏—Ä–∞–π—Ç–µ –Ω–∞–π–ø—Ä–æ—Å—Ç—ñ—à–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç

---

## üîó –ó–í'–Ø–ó–û–ö –ó –ù–ê–°–¢–£–ü–ù–ò–ú –†–û–ó–î–Ü–õ–û–ú

–í–∏ –æ–ø–∞–Ω—É–≤–∞–ª–∏ smart pointers –¥–ª—è –æ–¥–Ω–æ–ø–æ—Ç–æ–∫–æ–≤–æ–≥–æ –∫–æ–¥—É. –ê–ª–µ –∑–∞–ª–∏—à–∏–ª–æ—Å—å –ø–∏—Ç–∞–Ω–Ω—è: —â–æ —Ç–∞–∫–µ —Ü—ñ –∑–∞–≥–∞–¥–∫–æ–≤—ñ `'a` —É —Å–∏–≥–Ω–∞—Ç—É—Ä–∞—Ö —Ñ—É–Ω–∫—Ü—ñ–π? –ß–æ–º—É —ñ–Ω–æ–¥—ñ –∫–æ–º–ø—ñ–ª—è—Ç–æ—Ä –≤–∏–º–∞–≥–∞—î —ó—Ö –≤–∫–∞–∑—É–≤–∞—Ç–∏?

–£ **–†–æ–∑–¥—ñ–ª—ñ 32: –ß–∞—Å–∏ –∂–∏—Ç—Ç—è (Lifetimes)** –≤–∏ –¥—ñ–∑–Ω–∞—î—Ç–µ—Å—å:
- –©–æ —Ç–∞–∫–µ lifetime annotations
- –ö–æ–ª–∏ –∫–æ–º–ø—ñ–ª—è—Ç–æ—Ä –Ω–µ –º–æ–∂–µ –≤–∏–≤–µ—Å—Ç–∏ —á–∞—Å –∂–∏—Ç—Ç—è
- –Ø–∫ –ø–∏—Å–∞—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –∑ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º–∏

---

> **–ù–∞—Å—Ç—É–ø–Ω–∏–π —Ä–æ–∑–¥—ñ–ª:** [–†–æ–∑–¥—ñ–ª 32: –ß–∞—Å–∏ –∂–∏—Ç—Ç—è (Lifetimes)](./32_Lifetimes.md)
